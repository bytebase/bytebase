syntax = "proto3";

package bytebase.store;

option go_package = "generated-go/store";

// IssuePayloadApproval records the approval template used and approval history for an issue.
message IssuePayloadApproval {
  // Approver represents a user who can approve or reject an issue.
  message Approver {
    // Status represents the approver's decision state.
    enum Status {
      STATUS_UNSPECIFIED = 0;
      // Approval is pending from this approver.
      PENDING = 1;
      // Approver has approved the issue.
      APPROVED = 2;
      // Approver has rejected the issue.
      REJECTED = 3;
    }
    // The current approval status.
    Status status = 1;

    // The ID of the principal who is the approver.
    int32 principal_id = 2;
  }

  // The approval template being used for this issue.
  ApprovalTemplate approval_template = 1;
  // List of approvers and their current status.
  repeated Approver approvers = 2;

  // Whether the system has finished finding a matching approval template.
  // False means the backend is still searching for matching templates.
  bool approval_finding_done = 3;

  // Error message if approval template finding failed.
  string approval_finding_error = 4;

  // Reserved: risk_level was moved to Issue message
  reserved 5;
  reserved "risk_level";
}

// ApprovalTemplate defines the approval workflow and requirements for an issue.
message ApprovalTemplate {
  // The approval workflow specification.
  ApprovalFlow flow = 1;
  // Human-readable title of the approval template.
  string title = 2;
  // Detailed description of when this template applies.
  string description = 3;
}

// ApprovalFlow defines the sequence of approvals required.
message ApprovalFlow {
  // List of approval stages, in order.
  repeated ApprovalStage stages = 1;
  // Whether the flow is enabled.
  bool enabled = 2;
}

// ApprovalStage defines a single stage in an approval flow.
message ApprovalStage {
  // Unique identifier for the stage.
  int32 id = 1;
  // Name of the stage.
  string name = 2;
  // Description of the stage.
  string description = 3;
  // List of role names that must approve this stage.
  repeated string roles = 4;
  // Number of approvals required from the roles (default: 1).
  int32 required_approvals = 5;
  // Timeout for this stage in seconds (0 means no timeout).
  int32 timeout_seconds = 6;
}

// ApprovalHistory records the history of approval actions for an issue.
message ApprovalHistory {
  // Unique identifier for the history entry.
  int32 id = 1;
  // Issue ID.
  int32 issue_id = 2;
  // Stage ID.
  int32 stage_id = 3;
  // Approver principal ID.
  int32 approver_id = 4;
  // Action taken (approved or rejected).
  Approver.Status action = 5;
  // Comment provided by the approver.
  string comment = 6;
  // Timestamp of the action.
  int64 created_ts = 7;
}

// ApprovalNotification defines notification settings for approval actions.
message ApprovalNotification {
  // Whether email notifications are enabled.
  bool email_enabled = 1;
  // Whether in-app notifications are enabled.
  bool in_app_enabled = 2;
  // List of additional recipients for email notifications.
  repeated string email_recipients = 3;
}

syntax = "proto3";

package bytebase.store;

import "store/advice.proto";
import "store/common.proto";

option go_package = "generated-go/store";

enum PlanCheckType {
  PLAN_CHECK_TYPE_UNSPECIFIED = 0;
  PLAN_CHECK_TYPE_STATEMENT_ADVISE = 1;
  PLAN_CHECK_TYPE_STATEMENT_SUMMARY_REPORT = 2;
  PLAN_CHECK_TYPE_GHOST_SYNC = 3;
}

message PlanCheckRunResult {
  repeated Result results = 1;
  string error = 2;

  message Result {
    Advice.Status status = 1;
    string title = 2;
    string content = 3;
    int32 code = 4;

    // Target identification for consolidated results
    // Format: instances/{instance}/databases/{database}
    string target = 7;
    PlanCheckType type = 8;

    oneof report {
      SqlSummaryReport sql_summary_report = 5;
      SqlReviewReport sql_review_report = 6;
    }
    message SqlSummaryReport {
      // statement_types are the types of statements found in the SQL.
      repeated string statement_types = 1;
      int64 affected_rows = 2;
      ChangedResources changed_resources = 3;
    }
    message SqlReviewReport {
      // Position of the SQL statement.
      Position start_position = 1;
      Position end_position = 2;
    }
  }
}

message ChangedResources {
  repeated ChangedResourceDatabase databases = 1;
}

message ChangedResourceDatabase {
  string name = 1;

  repeated ChangedResourceSchema schemas = 2;
}

message ChangedResourceSchema {
  string name = 1;

  repeated ChangedResourceTable tables = 2;
}

message ChangedResourceTable {
  string name = 1;

  // The estimated row count of the table.
  int64 table_rows = 2;
}

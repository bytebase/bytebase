syntax = "proto3";

package bytebase.store;

import "store/common.proto";

option go_package = "generated-go/store";

message TaskRunLog {
  enum Type {
    TYPE_UNSPECIFIED = 0;
    SCHEMA_DUMP_START = 1;
    SCHEMA_DUMP_END = 2;
    COMMAND_EXECUTE = 3;
    COMMAND_RESPONSE = 4;
    DATABASE_SYNC_START = 5;
    DATABASE_SYNC_END = 6;
    TRANSACTION_CONTROL = 8;
    PRIOR_BACKUP_START = 9;
    PRIOR_BACKUP_END = 10;
    RETRY_INFO = 11;
    COMPUTE_DIFF_START = 12;
    COMPUTE_DIFF_END = 13;
    RELEASE_FILE_EXECUTE = 14;
  }
  Type type = 1;
  string deploy_id = 12;
  SchemaDumpStart schema_dump_start = 2;
  SchemaDumpEnd schema_dump_end = 3;
  CommandExecute command_execute = 4;
  CommandResponse command_response = 5;
  DatabaseSyncStart database_sync_start = 6;
  DatabaseSyncEnd database_sync_end = 7;
  TransactionControl transaction_control = 9;
  PriorBackupStart prior_backup_start = 10;
  PriorBackupEnd prior_backup_end = 11;
  RetryInfo retry_info = 13;
  ComputeDiffStart compute_diff_start = 14;
  ComputeDiffEnd compute_diff_end = 15;
  ReleaseFileExecute release_file_execute = 16;

  message SchemaDumpStart {}
  message SchemaDumpEnd {
    string error = 1;
  }
  message CommandExecute {
    // The byte offset range of the executed command in the sheet.
    // Uses byte offsets (not character indices) for efficient slicing of sheet content bytes.
    // Example: For "SELECT 你好;" in a UTF-8 sheet, range [0, 13) represents all 13 bytes.
    Range range = 1;

    // The statement to be executed.
    string statement = 2;
  }
  message CommandResponse {
    string error = 2;
    int64 affected_rows = 3;
    // `all_affected_rows` is the affected rows of each command.
    // `all_affected_rows` may be unavailable if the database driver doesn't support it. Caller should fallback to `affected_rows` in that case.
    repeated int64 all_affected_rows = 4;
  }
  message DatabaseSyncStart {}
  message DatabaseSyncEnd {
    string error = 1;
  }
  message TransactionControl {
    enum Type {
      TYPE_UNSPECIFIED = 0;
      BEGIN = 1;
      COMMIT = 2;
      ROLLBACK = 3;
    }
    Type type = 1;
    string error = 2;
  }
  message PriorBackupStart {}
  message PriorBackupEnd {
    PriorBackupDetail prior_backup_detail = 1;
    string error = 2;
  }
  message RetryInfo {
    string error = 1;
    int32 retry_count = 2;
    int32 maximum_retries = 3;
  }
  message ComputeDiffStart {}
  message ComputeDiffEnd {
    string error = 1;
  }
  message ReleaseFileExecute {
    // The version of the file being executed (e.g., "0001").
    string version = 1;
    // The file path within the release (e.g., "2.2/V0001_create_table.sql").
    string file_path = 2;
  }
}

// PriorBackupDetail contains information about automatic backups created before migration.
message PriorBackupDetail {
  // Item represents a single backup operation for a table.
  message Item {
    // Table identifies a database table.
    message Table {
      // The database containing the table.
      // Format: instances/{instance}/databases/{database}
      string database = 1;
      // Schema name (for databases that support schemas).
      string schema = 2;
      // Table name.
      string table = 3;
    }

    // The original table that was backed up.
    Table source_table = 1;
    // The backup table where data was copied.
    Table target_table = 2;
    // Starting position in SQL for this backup operation.
    Position start_position = 3;
    // Ending position in SQL for this backup operation.
    Position end_position = 4;
  }

  // List of backup operations performed.
  repeated Item items = 1;
}

syntax = "proto3";

package bytebase.v1;

import "google/api/annotations.proto";
import "google/protobuf/empty.proto";
import "v1/annotation.proto";
import "v1/user_service.proto";

option go_package = "github.com/bytebase/bytebase/backend/generated-go/v1";

// AuthService handles user authentication operations.
service AuthService {
  // Authenticates a user and returns access tokens.
  // Permissions required: None
  rpc Login(LoginRequest) returns (LoginResponse) {
    option (google.api.http) = {
      post: "/v1/auth/login"
      body: "*"
    };
    option (bytebase.v1.allow_without_credential) = true;
    option (bytebase.v1.audit) = true;
  }

  // Logs out the current user session.
  // Permissions required: None
  rpc Logout(LogoutRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/v1/auth/logout"
      body: "*"
    };
    option (bytebase.v1.allow_without_credential) = true;
    option (bytebase.v1.audit) = true;
  }

  // Exchanges an external OIDC token for a Bytebase access token.
  // Used by CI/CD pipelines with Workload Identity Federation.
  // Permissions required: None (validates via OIDC token)
  rpc ExchangeToken(ExchangeTokenRequest) returns (ExchangeTokenResponse) {
    option (google.api.http) = {
      post: "/v1/auth:exchangeToken"
      body: "*"
    };
    option (bytebase.v1.allow_without_credential) = true;
    option (bytebase.v1.audit) = true;
  }

  // Refreshes the access token using the refresh token cookie.
  // Permissions required: None (validates via refresh token cookie)
  rpc Refresh(RefreshRequest) returns (RefreshResponse) {
    option (google.api.http) = {
      post: "/v1/auth/refresh"
      body: "*"
    };
    option (bytebase.v1.allow_without_credential) = true;
  }
}

message LoginRequest {
  // User's email address.
  string email = 1;

  // User's password for authentication.
  string password = 2;

  // If true, sets access token and refresh token as HTTP-only cookies instead of
  // returning the token in the response body. Use for browser-based clients.
  bool web = 3;

  // The name of the identity provider.
  // Format: idps/{idp}
  string idp_name = 4;

  // The idp_context is used to get the user information from identity provider.
  IdentityProviderContext idp_context = 5;

  // The otp_code is used to verify the user's identity by MFA.
  optional string otp_code = 6;

  // The recovery_code is used to recovery the user's identity with MFA.
  optional string recovery_code = 7;

  // The mfa_temp_token is used to verify the user's identity by MFA.
  optional string mfa_temp_token = 8;
}

// Context for identity provider authentication.
message IdentityProviderContext {
  oneof context {
    // OAuth2 authentication context.
    OAuth2IdentityProviderContext oauth2_context = 1;
    // OpenID Connect authentication context.
    OIDCIdentityProviderContext oidc_context = 2;
  }
}

// OAuth2 authentication context.
message OAuth2IdentityProviderContext {
  // Authorization code from OAuth2 provider.
  string code = 1;
}

// OpenID Connect authentication context.
message OIDCIdentityProviderContext {
  // Authorization code from OIDC provider.
  string code = 1;
}

message LoginResponse {
  // Access token for authenticated requests.
  // Only returned when web=false. For web=true, the token is set as an HTTP-only cookie.
  string token = 1;

  // Temporary token for MFA verification.
  optional string mfa_temp_token = 2;

  // Whether user must reset password before continuing.
  bool require_reset_password = 3;

  // The user from the successful login.
  User user = 4;
}

// Request to logout current user session.
message LogoutRequest {}

message ExchangeTokenRequest {
  // External OIDC token (JWT) from CI/CD platform.
  string token = 1;

  // Workload Identity email for identifying which identity to authenticate as.
  // Format: {name}@workload.bytebase.com
  string email = 2;
}

message ExchangeTokenResponse {
  // Bytebase access token.
  string access_token = 1;
}

// Request to refresh the access token.
message RefreshRequest {}

// Response from refreshing the access token.
message RefreshResponse {}

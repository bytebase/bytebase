syntax = "proto3";

package bytebase.v1;

import "google/api/annotations.proto";
import "google/api/client.proto";
import "google/api/field_behavior.proto";
import "google/api/resource.proto";
import "google/protobuf/field_mask.proto";
import "google/protobuf/timestamp.proto";
import "v1/annotation.proto";
import "v1/common.proto";
import "v1/instance_service.proto";

option go_package = "github.com/bytebase/bytebase/backend/generated-go/v1";

// DatabaseService manages databases and their schemas.
service DatabaseService {
  // Retrieves a database by name.
  // Permissions required: bb.databases.get
  rpc GetDatabase(GetDatabaseRequest) returns (Database) {
    option (google.api.http) = {get: "/v1/{name=instances/*/databases/*}"};
    option (google.api.method_signature) = "name";
    option (bytebase.v1.permission) = "bb.databases.get";
    option (bytebase.v1.auth_method) = IAM;
  }

  // Retrieves multiple databases by their names.
  // Permissions required: bb.databases.get
  rpc BatchGetDatabases(BatchGetDatabasesRequest) returns (BatchGetDatabasesResponse) {
    option (google.api.http) = {
      get: "/v1/{parent=projects/*}/databases:batchGet"
      additional_bindings: {get: "/v1/{parent=instances/*}/databases:batchGet"}
    };
    option (bytebase.v1.permission) = "bb.databases.get";
    option (bytebase.v1.auth_method) = CUSTOM;
  }

  // Lists databases in a project, instance, or workspace.
  // Permissions required: bb.projects.get (for project parent), bb.databases.list (for workspace parent), or bb.instances.get (for instance parent)
  rpc ListDatabases(ListDatabasesRequest) returns (ListDatabasesResponse) {
    option (google.api.http) = {
      get: "/v1/{parent=projects/*}/databases"

      additional_bindings: {get: "/v1/{parent=instances/*}/databases"}
      additional_bindings: {get: "/v1/{parent=workspaces/*}/databases"}
    };

    option (google.api.method_signature) = "";
    option (bytebase.v1.permission) = "bb.databases.list";
    option (bytebase.v1.auth_method) = CUSTOM;
  }

  // Updates database properties such as labels and project assignment.
  // Permissions required: bb.databases.update
  rpc UpdateDatabase(UpdateDatabaseRequest) returns (Database) {
    option (google.api.http) = {
      patch: "/v1/{database.name=instances/*/databases/*}"
      body: "database"
    };
    option (google.api.method_signature) = "database,update_mask";
    option (bytebase.v1.permission) = "bb.databases.update";
    option (bytebase.v1.auth_method) = IAM;
    option (bytebase.v1.audit) = true;
  }

  // Updates multiple databases in a single batch operation.
  // Permissions required: bb.databases.update
  rpc BatchUpdateDatabases(BatchUpdateDatabasesRequest) returns (BatchUpdateDatabasesResponse) {
    option (google.api.http) = {
      post: "/v1/{parent=instances/*}/databases:batchUpdate"
      body: "*"
    };
    option (bytebase.v1.permission) = "bb.databases.update";
    option (bytebase.v1.auth_method) = IAM;
    option (bytebase.v1.audit) = true;
  }

  // Synchronizes database schema from the instance.
  // Permissions required: bb.databases.sync
  rpc SyncDatabase(SyncDatabaseRequest) returns (SyncDatabaseResponse) {
    option (google.api.http) = {
      post: "/v1/{name=instances/*/databases/*}:sync"
      body: "*"
    };
    option (bytebase.v1.permission) = "bb.databases.sync";
    option (bytebase.v1.auth_method) = IAM;
  }

  // Synchronizes multiple databases in a single batch operation.
  // Permissions required: bb.databases.sync
  rpc BatchSyncDatabases(BatchSyncDatabasesRequest) returns (BatchSyncDatabasesResponse) {
    option (google.api.http) = {
      post: "/v1/{parent=instances/*}/databases:batchSync"
      body: "*"
    };
    option (bytebase.v1.permission) = "bb.databases.sync";
    option (bytebase.v1.auth_method) = IAM;
  }

  // Retrieves database metadata including tables, columns, and indexes.
  // Permissions required: bb.databases.getSchema
  rpc GetDatabaseMetadata(GetDatabaseMetadataRequest) returns (DatabaseMetadata) {
    option (google.api.http) = {get: "/v1/{name=instances/*/databases/*/metadata}"};
    option (bytebase.v1.permission) = "bb.databases.getSchema";
    option (bytebase.v1.auth_method) = IAM;
  }

  // Retrieves database schema as DDL statements.
  // Permissions required: bb.databases.getSchema
  rpc GetDatabaseSchema(GetDatabaseSchemaRequest) returns (DatabaseSchema) {
    option (google.api.http) = {get: "/v1/{name=instances/*/databases/*/schema}"};
    option (bytebase.v1.permission) = "bb.databases.getSchema";
    option (bytebase.v1.auth_method) = IAM;
  }

  // Retrieves database schema in SDL (Schema Definition Language) format.
  // Permissions required: bb.databases.getSchema
  rpc GetDatabaseSDLSchema(GetDatabaseSDLSchemaRequest) returns (DatabaseSDLSchema) {
    option (google.api.http) = {get: "/v1/{name=instances/*/databases/*/sdlSchema}"};
    option (bytebase.v1.permission) = "bb.databases.getSchema";
    option (bytebase.v1.auth_method) = IAM;
  }

  // Compares and generates migration statements between two schemas.
  // Permissions required: bb.databases.get
  rpc DiffSchema(DiffSchemaRequest) returns (DiffSchemaResponse) {
    option (google.api.http) = {
      post: "/v1/{name=instances/*/databases/*}:diffSchema"
      body: "*"

      additional_bindings: {
        post: "/v1/{name=instances/*/databases/*/changelogs/*}:diffSchema"
        body: "*"
      }
    };
    // TODO(d): secure it.
    option (bytebase.v1.permission) = "bb.databases.get";
    option (bytebase.v1.auth_method) = IAM;
  }

  // Lists migration history for a database.
  // Permissions required: bb.changelogs.list
  rpc ListChangelogs(ListChangelogsRequest) returns (ListChangelogsResponse) {
    option (google.api.http) = {get: "/v1/{parent=instances/*/databases/*}/changelogs"};
    option (google.api.method_signature) = "parent";
    option (bytebase.v1.permission) = "bb.changelogs.list";
    option (bytebase.v1.auth_method) = IAM;
  }

  // Retrieves a specific changelog entry.
  // Permissions required: bb.changelogs.get
  rpc GetChangelog(GetChangelogRequest) returns (Changelog) {
    option (google.api.http) = {get: "/v1/{name=instances/*/databases/*/changelogs/*}"};
    option (google.api.method_signature) = "name";
    option (bytebase.v1.permission) = "bb.changelogs.get";
    option (bytebase.v1.auth_method) = IAM;
  }

  // Generates schema DDL for a database object.
  // Permissions required: bb.databases.getSchema
  rpc GetSchemaString(GetSchemaStringRequest) returns (GetSchemaStringResponse) {
    option (google.api.http) = {get: "/v1/{name=instances/*/databases/*/schemaString}"};
    option (google.api.method_signature) = "name";
    option (bytebase.v1.permission) = "bb.databases.getSchema";
    option (bytebase.v1.auth_method) = IAM;
  }
}

message GetDatabaseRequest {
  // The name of the database to retrieve.
  // Format: instances/{instance}/databases/{database}
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "bytebase.com/Database"}
  ];
}

message BatchGetDatabasesRequest {
  // The parent resource shared by all databases being retrieved.
  // - projects/{project}: batch get databases in a project;
  // - instances/{instances}: batch get databases in a instance;
  // Use "-" as wildcard to batch get databases across parent.
  string parent = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {child_type: "bytebase.com/Database"}
  ];

  // The list of database names to retrieve.
  repeated string names = 2 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "bytebase.com/Database"}
  ];
}

message BatchGetDatabasesResponse {
  // The databases from the specified request.
  repeated Database databases = 1;
}

message ListDatabasesRequest {
  // - projects/{project}: list databases in a project, require "bb.projects.get" permission.
  // - workspaces/-: list databases in the workspace, require "bb.databases.list" permission.
  // - instances/{instances}: list databases in a instance, require "bb.instances.get" permission
  string parent = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {child_type: "bytebase.com/Database"}
  ];

  // The maximum number of databases to return. The service may return fewer
  // than this value.
  // If unspecified, at most 10 databases will be returned.
  // The maximum value is 1000; values above 1000 will be coerced to 1000.
  int32 page_size = 2;

  // A page token, received from a previous `ListDatabases` call.
  // Provide this to retrieve the subsequent page.
  //
  // When paginating, all other parameters provided to `ListDatabases` must
  // match the call that provided the page token.
  string page_token = 3;

  // Filter is used to filter databases returned in the list.
  // The syntax and semantics of CEL are documented at https://github.com/google/cel-spec
  //
  // Supported filter:
  // - environment: the environment full name in "environments/{id}" format, support "==" operator.
  // - name: the database name, support ".matches()" operator.
  // - project: the project full name in "projects/{id}" format, support "==" operator.
  // - instance: the instance full name in "instances/{id}" format, support "==" operator.
  // - engine: the database engine, check Engine enum for values. Support "==", "in [xx]", "!(in [xx])" operator.
  // - exclude_unassigned: should be "true" or "false", will not show unassigned databases if it's true, support "==" operator.
  // - drifted: should be "true" or "false", show drifted databases if it's true, support "==" operator.
  // - table: filter by the database table, support "==" and ".matches()" operator.
  // - labels.{key}: the database label, support "==" and "in" operators.
  //
  // For example:
  // environment == "environments/{environment resource id}"
  // environment == "" (find databases which environment is not set)
  // project == "projects/{project resource id}"
  // instance == "instances/{instance resource id}"
  // name.matches("database name")
  // engine == "MYSQL"
  // engine in ["MYSQL", "POSTGRES"]
  // !(engine in ["MYSQL", "POSTGRES"])
  // exclude_unassigned == true
  // drifted == true
  // table == "sample"
  // table.matches("sam")
  // labels.environment == "production"
  // labels.region == "asia"
  // labels.region in ["asia", "europe"]
  //
  // You can combine filter conditions like:
  // environment == "environments/prod" && name.matches("employee")
  string filter = 4;

  // Show deleted database if specified.
  bool show_deleted = 5;

  // The order by of databases.
  // Support name, project, instance. The default sorting order is ascending.
  // For example:
  // - order_by = "name" - order by name ascending
  // - order_by = "name desc"
  // - order_by = "name desc, project asc"
  string order_by = 6;
}

message ListDatabasesResponse {
  // The databases from the specified request.
  repeated Database databases = 1;

  // A token, which can be sent as `page_token` to retrieve the next page.
  // If this field is omitted, there are no subsequent pages.
  string next_page_token = 2;
}

message UpdateDatabaseRequest {
  // The database to update.
  //
  // The database's `name` field is used to identify the database to update.
  // Format: instances/{instance}/databases/{database}
  Database database = 1 [(google.api.field_behavior) = REQUIRED];

  // The list of fields to update.
  google.protobuf.FieldMask update_mask = 2;

  // If set to true, and the database is not found, a new database will be created.
  // In this situation, `update_mask` is ignored.
  bool allow_missing = 3;
}

message BatchUpdateDatabasesRequest {
  // The parent resource shared by all databases being updated.
  // Format: instances/{instance}
  // If the operation spans parents, a dash (-) may be accepted as a wildcard.
  // We only support updating the project of databases for now.
  string parent = 1;

  // The request message specifying the resources to update.
  // A maximum of 1000 databases can be modified in a batch.
  repeated UpdateDatabaseRequest requests = 2 [(google.api.field_behavior) = REQUIRED];
}

message BatchUpdateDatabasesResponse {
  // Databases updated.
  repeated Database databases = 1;
}

message BatchSyncDatabasesRequest {
  // The parent resource shared by all databases being updated.
  // Format: instances/{instance}
  // If the operation spans parents, a dash (-) may be accepted as a wildcard.
  string parent = 1;

  // The list of database names to sync.
  repeated string names = 2 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "bytebase.com/Database"}
  ];
}

message BatchSyncDatabasesResponse {}

message SyncDatabaseRequest {
  // The name of the database to sync.
  // Format: instances/{instance}/databases/{database}
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "bytebase.com/Database"}
  ];
}

message SyncDatabaseResponse {}

message GetDatabaseMetadataRequest {
  // The name of the database to retrieve metadata.
  // Format: instances/{instance}/databases/{database}/metadata
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "bytebase.com/DatabaseMetadata"}
  ];

  // Filter is used to filter databases returned in the list.
  // The syntax and semantics of CEL are documented at https://github.com/google/cel-spec
  //
  // Supported filter:
  // - schema: the schema name, support "==" operator.
  // - table: the table name, support "==" and ".matches()" operator.
  //
  // For example:
  // schema == "schema-a"
  // table == "table-a"
  // table.matches("table-a")
  // schema == "schema-a" && table.matches("sample")
  // The filter used to search table with wildcard "sample" in the schema "schemas/schema-a".
  // The column masking level will only be returned when a table filter is used.
  string filter = 2;

  // Limit the response size of returned table metadata per schema.
  // For example, if the database has 3 schemas, and each schema has 100 tables,
  // if limit is 20, then only 20 tables will be returned for each schema, total 60 tables.
  // Default 0, means no limit.
  int32 limit = 3;
}

message GetDatabaseSchemaRequest {
  // The name of the database to retrieve schema.
  // Format: instances/{instance}/databases/{database}/schema
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "bytebase.com/DatabaseSchema"}
  ];
}

message GetDatabaseSDLSchemaRequest {
  // The name of the database to retrieve SDL schema.
  // Format: instances/{instance}/databases/{database}/sdlSchema
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "bytebase.com/Database"}
  ];

  // SDLFormat specifies the output format for SDL schema.
  enum SDLFormat {
    // Unspecified format. Defaults to SINGLE_FILE.
    SDL_FORMAT_UNSPECIFIED = 0;

    // Single file format: returns the complete SDL schema as a single file.
    SINGLE_FILE = 1;

    // Multi-file format: returns the SDL schema as a ZIP archive containing
    // multiple files organized by schema objects (tables, views, functions, etc.).
    MULTI_FILE = 2;
  }

  // The format of the SDL schema output.
  SDLFormat format = 2;
}

message DiffSchemaRequest {
  // The name of the database or changelog.
  // Format:
  // database: instances/{instance}/databases/{database}
  // changelog: instances/{instance}/databases/{database}/changelogs/{changelog}
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "bytebase.com/Database"}
  ];

  oneof target {
    // The target schema.
    string schema = 2;

    // The resource name of the changelog
    // Format:
    // instances/{instance}/databases/{database}/changelogs/{changelog}
    string changelog = 3;
  }
}

message DiffSchemaResponse {
  string diff = 1;
}

message Database {
  option (google.api.resource) = {
    type: "bytebase.com/Database"
    pattern: "instances/{instance}/databases/{database}"
  };

  // The name of the database.
  // Format: instances/{instance}/databases/{database}
  // {database} is the database name in the instance.
  string name = 1;

  // The existence of a database.
  State state = 2 [(google.api.field_behavior) = OUTPUT_ONLY];

  // The latest synchronization time.
  google.protobuf.Timestamp successful_sync_time = 3 [(google.api.field_behavior) = OUTPUT_ONLY];

  // The project for a database.
  // Format: projects/{project}
  string project = 4;

  // The version of database schema.
  string schema_version = 5 [(google.api.field_behavior) = OUTPUT_ONLY];

  // The environment resource.
  // Format: environments/prod where prod is the environment resource ID.
  optional string environment = 6 [(google.api.field_behavior) = OPTIONAL];

  // The effective environment based on environment tag above and environment
  // tag on the instance. Inheritance follows
  // https://cloud.google.com/resource-manager/docs/tags/tags-overview.
  optional string effective_environment = 7 [(google.api.field_behavior) = OUTPUT_ONLY];

  // Labels will be used for deployment and policy control.
  map<string, string> labels = 8;

  // The instance resource.
  InstanceResource instance_resource = 9 [(google.api.field_behavior) = OUTPUT_ONLY];

  // The database is available for DML prior backup.
  bool backup_available = 10 [(google.api.field_behavior) = OUTPUT_ONLY];

  // The schema is drifted from the source of truth.
  bool drifted = 11 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// DatabaseMetadata is the metadata for databases.
message DatabaseMetadata {
  option (google.api.resource) = {
    type: "bytebase.com/DatabaseMetadata"
    pattern: "instances/{instance}/databases/{database}/metadata"
  };

  // The database metadata name.
  //
  // Format: instances/{instance}/databases/{database}/metadata
  string name = 1;

  // The schemas is the list of schemas in a database.
  repeated SchemaMetadata schemas = 2;

  // The character_set is the character set of a database.
  string character_set = 3;

  // The collation is the collation of a database.
  string collation = 4;

  // The extensions is the list of extensions in a database.
  repeated ExtensionMetadata extensions = 5;

  // The owner of the database.
  string owner = 6;

  // The search_path is the search path of a PostgreSQL database.
  string search_path = 7;
}

// SchemaMetadata is the metadata for schemas.
// This is the concept of schema in Postgres, but it's a no-op for MySQL.
message SchemaMetadata {
  // The name is the schema name.
  // It is an empty string for databases without such concept such as MySQL.
  string name = 1;

  // The tables is the list of tables in a schema.
  repeated TableMetadata tables = 2;

  // The external_tables is the list of external tables in a schema.
  repeated ExternalTableMetadata external_tables = 3;

  // The views is the list of views in a schema.
  repeated ViewMetadata views = 4;

  // The functions is the list of functions in a schema.
  repeated FunctionMetadata functions = 5;

  // The procedures is the list of procedures in a schema.
  repeated ProcedureMetadata procedures = 6;

  // The streams is the list of streams in a schema, currently, only used for
  // Snowflake.
  repeated StreamMetadata streams = 7;

  // The routines is the list of routines in a schema, currently, only used for
  // Snowflake.
  repeated TaskMetadata tasks = 8;

  // The materialized_views is the list of materialized views in a schema.
  repeated MaterializedViewMetadata materialized_views = 9;

  // The packages is the list of packages in a schema.
  repeated PackageMetadata packages = 10;

  // The owner of the schema.
  string owner = 11;

  // The sequences is the list of sequences in a schema, sorted by name.
  repeated SequenceMetadata sequences = 12;

  // The events is the list of scheduled events in a schema.
  repeated EventMetadata events = 13;

  // The enum_types is the list of user-defined enum types in a schema.
  repeated EnumTypeMetadata enum_types = 14;

  // Whether to skip this schema during schema dump operations.
  bool skip_dump = 15;

  // The comment is the comment of a schema.
  string comment = 16;
}

message EnumTypeMetadata {
  // The name of a type.
  string name = 1;

  // The enum values of a type.
  repeated string values = 2;

  // The comment describing the enum type.
  string comment = 3;

  // Whether to skip this enum type during schema dump operations.
  bool skip_dump = 4;
}

message EventMetadata {
  // The name of the event.
  string name = 1;

  // The schedule of the event.
  string definition = 2;

  // The time zone of the event.
  string time_zone = 3;

  // The SQL mode setting for the event.
  string sql_mode = 4;

  // The character set used by the client creating the event.
  string character_set_client = 5;

  // The collation used for the connection when creating the event.
  string collation_connection = 6;

  // The comment is the comment of an event.
  string comment = 7;
}

message SequenceMetadata {
  // The name of a sequence.
  string name = 1;

  // The data type of a sequence.
  string data_type = 2;

  // The start value of a sequence.
  string start = 3;

  // The minimum value of a sequence.
  string min_value = 4;

  // The maximum value of a sequence.
  string max_value = 5;

  // Increment value of a sequence.
  string increment = 6;

  // Cycle is whether the sequence cycles.
  bool cycle = 7;

  // Cache size of a sequence.
  string cache_size = 8;

  // Last value of a sequence.
  string last_value = 9;

  // The owner table of the sequence.
  string owner_table = 10;

  // The owner column of the sequence.
  string owner_column = 11;

  // The comment describing the sequence.
  string comment = 12;

  // Whether to skip this sequence during schema dump operations.
  bool skip_dump = 13;
}

message TriggerMetadata {
  // The name is the name of the trigger.
  string name = 1;

  // The event is the event of the trigger, such as INSERT, UPDATE, DELETE,
  // TRUNCATE.
  string event = 2;

  // The timing is the timing of the trigger, such as BEFORE, AFTER.
  string timing = 3;

  // The body is the body of the trigger.
  string body = 4;

  // The SQL mode setting for the trigger.
  string sql_mode = 5;

  // The character set used by the client creating the trigger.
  string character_set_client = 6;

  // The collation used for the connection when creating the trigger.
  string collation_connection = 7;

  // The comment describing the trigger.
  string comment = 8;

  // Whether to skip this trigger during schema dump operations.
  bool skip_dump = 9;
}

message ExternalTableMetadata {
  // The name is the name of a external table.
  string name = 1;

  // The external_server_name is the name of the external server.
  string external_server_name = 2;

  // The external_database_name is the name of the external database.
  string external_database_name = 3;

  // The columns is the ordered list of columns in a foreign table.
  repeated ColumnMetadata columns = 4;
}

// TableMetadata is the metadata for tables.
message TableMetadata {
  // The name is the name of a table.
  string name = 1;

  // The columns is the ordered list of columns in a table.
  repeated ColumnMetadata columns = 2;

  // The indexes is the list of indexes in a table.
  repeated IndexMetadata indexes = 3;

  // The engine is the engine of a table.
  string engine = 4;

  // The collation is the collation of a table.
  string collation = 5;

  // The character set of table.
  string charset = 6;

  // The row_count is the estimated number of rows of a table.
  int64 row_count = 7;

  // The data_size is the estimated data size of a table.
  int64 data_size = 8;

  // The index_size is the estimated index size of a table.
  int64 index_size = 9;

  // The data_free is the estimated free data size of a table.
  int64 data_free = 10;

  // The create_options is the create option of a table.
  string create_options = 11;

  // The comment is the comment of a table.
  string comment = 12;

  // The foreign_keys is the list of foreign keys in a table.
  repeated ForeignKeyMetadata foreign_keys = 13;

  // The partitions is the list of partitions in a table.
  repeated TablePartitionMetadata partitions = 14;

  // The check_constraints is the list of check constraints in a table.
  repeated CheckConstraintMetadata check_constraints = 15;

  // The owner of the table.
  string owner = 16;

  // The sorting_keys is a tuple of column names or arbitrary expressions. ClickHouse specific field.
  // Reference: https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree#order_by
  repeated string sorting_keys = 17;

  // The triggers is the list of triggers associated with the table.
  repeated TriggerMetadata triggers = 18;

  // Whether to skip this table during schema dump operations.
  bool skip_dump = 19;

  // https://docs.pingcap.com/tidb/stable/information-schema-tables/
  string sharding_info = 20;

  // https://docs.pingcap.com/tidb/stable/clustered-indexes/#clustered-indexes
  // CLUSTERED or NONCLUSTERED.
  string primary_key_type = 21;
}

// CheckConstraintMetadata is the metadata for check constraints.
message CheckConstraintMetadata {
  // The name is the name of a check constraint.
  string name = 1;

  // The expression is the expression of a check constraint.
  string expression = 2;
}

// TablePartitionMetadata is the metadata for table partitions.
message TablePartitionMetadata {
  // The name is the name of a table partition.
  string name = 1;

  // Type is the type of a table partition, some database engines may not
  // support all types. Only avilable for the following database engines now:
  // MySQL: RANGE, RANGE COLUMNS, LIST, LIST COLUMNS, HASH, LINEAR HASH, KEY,
  // LINEAR_KEY
  // (https://dev.mysql.com/doc/refman/8.0/en/partitioning-types.html) TiDB:
  // RANGE, RANGE COLUMNS, LIST, LIST COLUMNS, HASH, KEY PostgreSQL: RANGE,
  // LIST, HASH (https://www.postgresql.org/docs/current/ddl-partitioning.html)
  enum Type {
    TYPE_UNSPECIFIED = 0;
    RANGE = 1;
    RANGE_COLUMNS = 2;
    LIST = 3;
    LIST_COLUMNS = 4;
    HASH = 5;
    LINEAR_HASH = 6;
    KEY = 7;
    LINEAR_KEY = 8;
  }

  // The type of a table partition.
  Type type = 2;

  // The expression is the expression of a table partition.
  // For PostgreSQL, the expression is the text of {FOR VALUES
  // partition_bound_spec}, see
  // https://www.postgresql.org/docs/current/sql-createtable.html. For MySQL,
  // the expression is the `expr` or `column_list` of the following syntax.
  // PARTITION BY
  //    { [LINEAR] HASH(expr)
  //    | [LINEAR] KEY [ALGORITHM={1 | 2}] (column_list)
  //    | RANGE{(expr) | COLUMNS(column_list)}
  //    | LIST{(expr) | COLUMNS(column_list)} }.
  string expression = 3;

  // The value is the value of a table partition.
  // For MySQL, the value is for RANGE and LIST partition types,
  // - For a RANGE partition, it contains the value set in the partition's
  // VALUES LESS THAN clause, which can be either an integer or MAXVALUE.
  // - For a LIST partition, this column contains the values defined in the
  // partition's VALUES IN clause, which is a list of comma-separated integer
  // values.
  // - For others, it's an empty string.
  string value = 4;

  // The use_default is whether the users use the default partition, it stores
  // the different value for different database engines. For MySQL, it's [INT]
  // type, 0 means not use default partition, otherwise, it's equals to number
  // in syntax [SUB]PARTITION {number}.
  string use_default = 5;

  // The subpartitions is the list of subpartitions in a table partition.
  repeated TablePartitionMetadata subpartitions = 6;

  repeated IndexMetadata indexes = 7;

  repeated CheckConstraintMetadata check_constraints = 8;
}

// ColumnMetadata is the metadata for columns.
message ColumnMetadata {
  // The name is the name of a column.
  string name = 1;

  // The position is the position in columns.
  int32 position = 2;

  bool has_default = 3;

  // The default value of column.
  string default = 4;

  // Oracle specific metadata.
  // The default_on_null is the default on null of a column.
  bool default_on_null = 5;

  // The on_update is the on update action of a column.
  // For MySQL like databases, it's only supported for TIMESTAMP columns with
  // CURRENT_TIMESTAMP as on update value.
  string on_update = 6;

  // The nullable is the nullable of a column.
  bool nullable = 7;

  // The type is the type of a column.
  string type = 8;

  // The character_set is the character_set of a column.
  string character_set = 9;

  // The collation is the collation of a column.
  string collation = 10;

  // The comment is the comment of a column.
  string comment = 11;

  // The generation is the generation of a column.
  GenerationMetadata generation = 12;

  bool is_identity = 13;

  enum IdentityGeneration {
    IDENTITY_GENERATION_UNSPECIFIED = 0;
    ALWAYS = 1;
    BY_DEFAULT = 2;
  }

  // The identity_generation is for identity columns, PG only.
  IdentityGeneration identity_generation = 14;

  // The identity_seed is for identity columns, MSSQL only.
  int64 identity_seed = 15;

  // The identity_increment is for identity columns, MSSQL only.
  int64 identity_increment = 16;

  // The default_constraint_name is the name of the default constraint, MSSQL only.
  // In MSSQL, default values are implemented as named constraints. When modifying or
  // dropping a column's default value, you must reference the constraint by name.
  // This field stores the actual constraint name from the database.
  //
  // Example: A column definition like:
  //   CREATE TABLE employees (
  //     status NVARCHAR(20) DEFAULT 'active'
  //   )
  //
  // Will create a constraint with an auto-generated name like 'DF__employees__statu__3B75D760'
  // or a user-defined name if specified:
  //   ALTER TABLE employees ADD CONSTRAINT DF_employees_status DEFAULT 'active' FOR status
  //
  // To modify the default, you must first drop the existing constraint by name:
  //   ALTER TABLE employees DROP CONSTRAINT DF__employees__statu__3B75D760
  //   ALTER TABLE employees ADD CONSTRAINT DF_employees_status DEFAULT 'inactive' FOR status
  //
  // This field is populated when syncing from the database. When empty (e.g., when parsing
  // from SQL files), the system cannot automatically drop the constraint.
  string default_constraint_name = 17;
}

message GenerationMetadata {
  enum Type {
    TYPE_UNSPECIFIED = 0;
    VIRTUAL = 1;
    STORED = 2;
  }

  Type type = 1;
  string expression = 2;
}

// ViewMetadata is the metadata for views.
message ViewMetadata {
  // The name is the name of a view.
  string name = 1;

  // The definition is the definition of a view.
  string definition = 2;

  // The comment is the comment of a view.
  string comment = 3;

  // The dependency_columns is the list of dependency columns of a view.
  repeated DependencyColumn dependency_columns = 4;

  // The columns is the ordered list of columns in a table.
  repeated ColumnMetadata columns = 5;

  // The triggers is the list of triggers in a view.
  repeated TriggerMetadata triggers = 6;

  bool skip_dump = 7;
}

// DependencyColumn is the metadata for dependency columns.
message DependencyColumn {
  // The schema is the schema of a reference column.
  string schema = 1;

  // The table is the table of a reference column.
  string table = 2;

  // The column is the name of a reference column.
  string column = 3;
}

// MaterializedViewMetadata is the metadata for materialized views.
message MaterializedViewMetadata {
  // The name is the name of a materialized view.
  string name = 1;

  // The definition is the definition of a materialized view.
  string definition = 2;

  // The comment is the comment of a materialized view.
  string comment = 3;

  // The dependency_columns is the list of dependency columns of a materialized
  // view.
  repeated DependencyColumn dependency_columns = 4;

  // The columns is the ordered list of columns in a table.
  repeated TriggerMetadata triggers = 5;

  // The indexes is the list of indexes in a table.
  repeated IndexMetadata indexes = 6;

  bool skip_dump = 7;
}

message DependencyTable {
  // The schema is the schema of a reference table.
  string schema = 1;

  // The table is the name of a reference table.
  string table = 2;
}

// FunctionMetadata is the metadata for functions.
message FunctionMetadata {
  // The name is the name of a function.
  string name = 1;

  // The definition is the definition of a function.
  string definition = 2;

  // The signature is the name with the number and type of input arguments the
  // function takes.
  string signature = 3;

  // MySQL specific metadata.
  string character_set_client = 4;

  string collation_connection = 5;

  string database_collation = 6;

  string sql_mode = 7;

  string comment = 8;

  // The dependency_tables is the list of dependency tables of a function.
  // For PostgreSQL, it's the list of tables that the function depends on the return type definition.
  repeated DependencyTable dependency_tables = 9;

  bool skip_dump = 10;
}

// ProcedureMetadata is the metadata for procedures.
message ProcedureMetadata {
  // The name is the name of a procedure.
  string name = 1;

  // The definition is the definition of a procedure.
  string definition = 2;

  // The signature is the name with the number and type of input arguments the
  // procedure takes.
  string signature = 3;

  // MySQL specific metadata.
  string character_set_client = 4;

  string collation_connection = 5;

  string database_collation = 6;

  string sql_mode = 7;

  // The comment is the comment of a procedure.
  string comment = 9;

  bool skip_dump = 8;
}

// PackageMetadata is the metadata for packages.
message PackageMetadata {
  // The name is the name of a package.
  string name = 1;

  // The definition is the definition of a package.
  string definition = 2;
}

message TaskMetadata {
  // The name is the name of a task.
  string name = 1;

  // The id is the snowflake-generated id of a task.
  // Example: 01ad32a0-1bb6-5e93-0000-000000000001
  string id = 2;

  // The owner of the task.
  string owner = 3;

  // The comment of the task.
  string comment = 4;

  // The warehouse of the task.
  string warehouse = 5;

  // The schedule interval of the task.
  string schedule = 6;

  // The predecessor tasks of the task.
  repeated string predecessors = 7;

  enum State {
    STATE_UNSPECIFIED = 0;
    STARTED = 1;
    SUSPENDED = 2;
  }
  // The state of the task.
  State state = 8;

  // The condition of the task.
  string condition = 9;

  // The definition of the task.
  string definition = 10;
}

message StreamMetadata {
  // The name is the name of a stream.
  string name = 1;

  // The table_name is the name of the table/view that the stream is created on.
  string table_name = 2;

  // The owner of the stream.
  string owner = 3;

  // The comment of the stream.
  string comment = 4;

  enum Type {
    TYPE_UNSPECIFIED = 0;
    DELTA = 1;
  }
  // The type of the stream.
  Type type = 5;

  // Indicates whether the stream was last read before the `stale_after` time.
  bool stale = 6;

  enum Mode {
    MODE_UNSPECIFIED = 0;
    DEFAULT = 1;
    APPEND_ONLY = 2;
    INSERT_ONLY = 3;
  }
  // The mode of the stream.
  Mode mode = 7;

  // The definition of the stream.
  string definition = 8;
}

// SpatialIndexConfig defines the spatial index configuration for spatial databases.
message SpatialIndexConfig {
  // Spatial indexing method (e.g., "SPATIAL", "R-TREE", "GIST")
  string method = 1;

  // Tessellation configuration for grid-based spatial indexes
  TessellationConfig tessellation = 2;

  // Storage and performance configuration
  StorageConfig storage = 3;

  // Dimensional configuration
  DimensionalConfig dimensional = 4;
}

// TessellationConfig defines tessellation parameters for spatial indexes.
message TessellationConfig {
  // Tessellation scheme (e.g., "GEOMETRY_GRID", "GEOGRAPHY_GRID", "GEOMETRY_AUTO_GRID")
  string scheme = 1;

  // Grid levels and densities for multi-level tessellation
  repeated GridLevel grid_levels = 2;

  // Number of cells per object (1-8192 for SQL Server)
  int32 cells_per_object = 3;

  // Bounding box for GEOMETRY tessellation (not used for GEOGRAPHY)
  BoundingBox bounding_box = 4;
}

// GridLevel defines a tessellation grid level with its density.
message GridLevel {
  // Grid level number (1-4 for SQL Server)
  int32 level = 1;

  // Grid density (LOW, MEDIUM, HIGH)
  string density = 2;
}

// BoundingBox defines the spatial bounds for GEOMETRY spatial indexes.
message BoundingBox {
  // Minimum X coordinate
  double xmin = 1;

  // Minimum Y coordinate
  double ymin = 2;

  // Maximum X coordinate
  double xmax = 3;

  // Maximum Y coordinate
  double ymax = 4;
}

// StorageConfig defines storage and performance parameters for spatial indexes.
message StorageConfig {
  // Fill factor percentage (1-100)
  int32 fillfactor = 1;

  // Buffering mode for PostgreSQL (auto, on, off)
  string buffering = 2;

  // Tablespace configuration for Oracle
  string tablespace = 3;
  string work_tablespace = 4;
  int32 sdo_level = 5;
  int32 commit_interval = 6;

  // SQL Server specific parameters
  bool pad_index = 7;
  string sort_in_tempdb = 8; // ON, OFF
  bool drop_existing = 9;
  bool online = 10;
  bool allow_row_locks = 11;
  bool allow_page_locks = 12;
  int32 maxdop = 13;
  string data_compression = 14; // NONE, ROW, PAGE
}

// DimensionalConfig defines dimensional and constraint parameters for spatial indexes.
message DimensionalConfig {
  // Number of dimensions (2-4, default 2)
  int32 dimensions = 1;

  // Spatial data type (GEOMETRY, GEOGRAPHY, POINT, POLYGON, etc.)
  string data_type = 2;

  // Spatial reference system identifier (SRID)
  int32 srid = 3;

  // Coordinate system constraints
  repeated DimensionConstraint constraints = 4;
}

// DimensionConstraint defines constraints for a spatial dimension.
message DimensionConstraint {
  // Dimension name/type (X, Y, Z, M, etc.)
  string dimension = 1;

  // Minimum value for this dimension
  double min_value = 2;

  // Maximum value for this dimension
  double max_value = 3;

  // Tolerance for this dimension
  double tolerance = 4;
}

// IndexMetadata is the metadata for indexes.
message IndexMetadata {
  // The name is the name of an index.
  string name = 1;

  // The expressions are the ordered columns or expressions of an index.
  // This could refer to a column or an expression.
  repeated string expressions = 2;

  // The key_lengths are the ordered key lengths of an index.
  // If the key length is not specified, it's -1.
  repeated int64 key_length = 3;

  // The descending is the ordered descending of an index.
  repeated bool descending = 4;

  // The type is the type of an index.
  string type = 5;

  // The unique is whether the index is unique.
  bool unique = 6;

  // The primary is whether the index is a primary key index.
  bool primary = 7;

  // The visible is whether the index is visible.
  bool visible = 8;

  // The comment is the comment of an index.
  string comment = 9;

  // The definition of an index.
  string definition = 10;

  // The schema name of the parent index.
  string parent_index_schema = 11;

  // The index name of the parent index.
  string parent_index_name = 12;

  // The number of granules in the block. It's a ClickHouse specific field.
  int64 granularity = 13;

  // It's a PostgreSQL specific field.
  // The unique constraint and unique index are not the same thing in PostgreSQL.
  bool is_constraint = 14;

  // Spatial index configuration for spatial databases like SQL Server, PostgreSQL with PostGIS, etc.
  SpatialIndexConfig spatial_config = 15;

  // https://www.postgresql.org/docs/current/catalog-pg-opclass.html
  // Name of the operator class for each column. (PostgreSQL specific).
  repeated string opclass_names = 16;
  // True if the operator class is the default. (PostgreSQL specific).
  repeated bool opclass_defaults = 17;
}

// ExtensionMetadata is the metadata for extensions.
message ExtensionMetadata {
  // The name is the name of an extension.
  string name = 1;

  // The schema is the extension that is installed to. But the extension usage
  // is not limited to the schema.
  string schema = 2;

  // The version is the version of an extension.
  string version = 3;

  // The description is the description of an extension.
  string description = 4;
}

// ForeignKeyMetadata is the metadata for foreign keys.
message ForeignKeyMetadata {
  // The name is the name of a foreign key.
  string name = 1;

  // The columns are the ordered referencing columns of a foreign key.
  repeated string columns = 2;

  // The referenced_schema is the referenced schema name of a foreign key.
  // It is an empty string for databases without such concept such as MySQL.
  string referenced_schema = 3;

  // The referenced_table is the referenced table name of a foreign key.
  string referenced_table = 4;

  // The referenced_columns are the ordered referenced columns of a foreign key.
  repeated string referenced_columns = 5;

  // The on_delete is the on delete action of a foreign key.
  string on_delete = 6;

  // The on_update is the on update action of a foreign key.
  string on_update = 7;

  // The match_type is the match type of a foreign key.
  // The match_type is the PostgreSQL specific field.
  // It's empty string for other databases.
  string match_type = 8;
}

// DatabaseSchema is the metadata for databases.
message DatabaseSchema {
  // The schema dump from database.
  string schema = 1;
}

// DatabaseSDLSchema contains the schema in SDL format.
message DatabaseSDLSchema {
  // The SDL schema content.
  // - For SINGLE_FILE format: contains the complete SDL schema as a text string.
  // - For MULTI_FILE format: contains the ZIP archive as binary data.
  bytes schema = 1;

  // The MIME type of the schema content.
  // Indicates how the client should interpret the schema field.
  // Examples:
  // - "text/plain; charset=utf-8" for SINGLE_FILE format
  // - "application/zip" for MULTI_FILE format
  string content_type = 2 [(google.api.field_behavior) = OUTPUT_ONLY];
}

enum ChangelogView {
  // The default / unset value.
  // The API will default to the BASIC view.
  CHANGELOG_VIEW_UNSPECIFIED = 0;
  CHANGELOG_VIEW_BASIC = 1;
  CHANGELOG_VIEW_FULL = 2;
}

message ListChangelogsRequest {
  // The parent of the changelogs.
  // Format: instances/{instance}/databases/{database}
  string parent = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "bytebase.com/Database"}
  ];

  // The maximum number of changelogs to return. The service may return fewer
  // than this value. If unspecified, at most 10 changelogs will be returned.
  // The maximum value is 1000; values above 1000 will be coerced to 1000.
  int32 page_size = 2;

  // A page token, received from the previous call.
  // Provide this to retrieve the subsequent page.
  //
  // When paginating, all other parameters provided must match
  // the call that provided the page token.
  string page_token = 3;

  ChangelogView view = 4;

  // Filter is used to filter changelogs returned in the list.
  // The syntax and semantics of CEL are documented at https://github.com/google/cel-spec
  //
  // Supported filter:
  // status: the changelog status, support "==" operation. check Changelog.Status for available values.
  // type: the changelog type, support "in" and "==" operation. check Changelog.Type for available values.
  //
  // Example:
  // status == "DONE"
  // type in ["BASELINE", "MIGRATE"]
  // status == "FAILED" && type == "SDL"
  string filter = 5;
}

message ListChangelogsResponse {
  // The list of changelogs.
  repeated Changelog changelogs = 1;

  // A token, which can be sent as `page_token` to retrieve the next page.
  // If this field is omitted, there are no subsequent pages.
  string next_page_token = 2;
}

message GetChangelogRequest {
  // The name of the changelog to retrieve.
  // Format: instances/{instance}/databases/{database}/changelogs/{changelog}
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "bytebase.com/DatabaseChangelog"}
  ];

  ChangelogView view = 2;
}

message Changelog {
  option (google.api.resource) = {
    type: "bytebase.com/DatabaseChangelog"
    pattern: "instances/{instance}/databases/{database}/changelogs/{changelog}"
  };

  // Format: instances/{instance}/databases/{database}/changelogs/{changelog}
  string name = 1;

  google.protobuf.Timestamp create_time = 2;

  enum Status {
    STATUS_UNSPECIFIED = 0;
    PENDING = 1;
    DONE = 2;
    FAILED = 3;
  }
  Status status = 3;

  string schema = 7;
  int64 schema_size = 8;

  // Format: projects/{project}/plans/{plan}/rollout/stages/{stage}/tasks/{task}/taskRuns/{taskRun}
  string task_run = 11;

  // The title of the plan associated with this changelog's task run.
  // This field is populated by deriving the plan from task_run for display purposes.
  string plan_title = 15 [(google.api.field_behavior) = OUTPUT_ONLY];

  enum Type {
    TYPE_UNSPECIFIED = 0;
    BASELINE = 1;
    MIGRATE = 2;
    SDL = 3;
  }
  Type type = 14;
}

message GetSchemaStringRequest {
  // The name of the database.
  // Format: instances/{instance}/databases/{database}
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "bytebase.com/Database"}
  ];

  // This API is used to generate the schema string for the database.
  // It can accept the two types of input:
  // 1. The type, schema and object are required.
  // 2. The metadata is required.
  // For the first type, the schema string is generated based on the db schema in the backend.
  // For the second type, the schema string is generated based on the metadata.

  enum ObjectType {
    OBJECT_TYPE_UNSPECIFIED = 0;
    DATABASE = 1;
    SCHEMA = 2;
    TABLE = 3;
    VIEW = 4;
    MATERIALIZED_VIEW = 5;
    FUNCTION = 6;
    PROCEDURE = 7;
    SEQUENCE = 8;
  }
  ObjectType type = 2;
  // It's empty for DATABASE.
  string schema = 3;
  // It's empty for DATABASE and SCHEMA.
  string object = 4;

  // If use the metadata to generate the schema string, the type is OBJECT_TYPE_UNSPECIFIED.
  // Also the schema and object are empty.
  DatabaseMetadata metadata = 5;
}

message GetSchemaStringResponse {
  string schema_string = 1;
}

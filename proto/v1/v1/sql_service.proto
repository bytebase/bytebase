syntax = "proto3";

package bytebase.v1;

import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/api/resource.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "v1/annotation.proto";
import "v1/common.proto";
import "v1/database_service.proto";

option go_package = "github.com/bytebase/bytebase/backend/generated-go/v1";

// SQLService executes SQL queries and manages query operations.
service SQLService {
  // Executes a read-only SQL query against a database.
  // Permissions required: bb.databases.get
  rpc Query(QueryRequest) returns (QueryResponse) {
    option (google.api.http) = {
      post: "/v1/{name=instances/*/databases/*}:query"
      body: "*"
    };
    option (bytebase.v1.permission) = "bb.databases.get";
    option (bytebase.v1.auth_method) = IAM;
    option (bytebase.v1.audit) = true;
  }

  // Executes SQL with admin privileges via streaming connection.
  // Permissions required: bb.sql.admin
  rpc AdminExecute(stream AdminExecuteRequest) returns (stream AdminExecuteResponse) {
    // GRPC streaming / websocket requires GET method instead of POST.
    option (google.api.http) = {get: "/v1:adminExecute"};
    option (bytebase.v1.permission) = "bb.sql.admin";
    option (bytebase.v1.auth_method) = IAM;
    option (bytebase.v1.audit) = true;
  }

  // SearchQueryHistories searches query histories for the caller.
  // Permissions required: None (only returns caller's own query histories)
  rpc SearchQueryHistories(SearchQueryHistoriesRequest) returns (SearchQueryHistoriesResponse) {
    option (google.api.http) = {
      post: "/v1/queryHistories:search"
      body: "*"
    };
    option (bytebase.v1.auth_method) = CUSTOM;
  }

  // Exports query results to a file format.
  // Permissions required: bb.databases.get
  rpc Export(ExportRequest) returns (ExportResponse) {
    option (google.api.http) = {
      post: "/v1/{name=instances/*/databases/*}:export"
      body: "*"

      additional_bindings: {
        post: "/v1/{name=projects/*/rollouts/*}:export"
        body: "*"
      }
      additional_bindings: {
        post: "/v1/{name=projects/*/rollouts/*/stages/*}:export"
        body: "*"
      }
    };
    option (bytebase.v1.permission) = "bb.databases.get";
    option (bytebase.v1.auth_method) = IAM;
    option (bytebase.v1.audit) = true;
  }

  // Computes schema differences between two database metadata.
  // Permissions required: None
  rpc DiffMetadata(DiffMetadataRequest) returns (DiffMetadataResponse) {
    option (google.api.http) = {
      post: "/v1/schemaDesign:diffMetadata"
      body: "*"
    };
    option (bytebase.v1.allow_without_credential) = true;
    // This is a util method requiring no authentication thus no authorization.
  }

  // Provides AI-powered SQL completion and generation.
  // Permissions required: None (authenticated users only, requires AI to be enabled)
  rpc AICompletion(AICompletionRequest) returns (AICompletionResponse) {
    option (google.api.http) = {
      post: "/v1/sql/aiCompletion"
      body: "*"
    };
    option (bytebase.v1.auth_method) = CUSTOM;
  }
}

message AdminExecuteRequest {
  // The name is the instance name to execute the query against.
  // Format: instances/{instance}/databases/{databaseName}
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "bytebase.com/Database"}
  ];

  // The SQL statement to execute.
  string statement = 2;

  // The maximum number of rows to return.
  int32 limit = 3;

  // The default schema to execute the statement. Equals to the current schema
  // in Oracle and search path in Postgres.
  optional string schema = 4;

  // Container is the container name to execute the query against, used for
  // CosmosDB only.
  optional string container = 5;
}

message AdminExecuteResponse {
  // The query results.
  repeated QueryResult results = 1;
}

message QueryRequest {
  // The name is the instance name to execute the query against.
  // Format: instances/{instance}/databases/{databaseName}
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "bytebase.com/Database"}
  ];

  // The SQL statement to execute.
  string statement = 2;

  // The maximum number of rows to return.
  int32 limit = 3;

  // The id of data source.
  // It is used for querying admin data source even if the instance has
  // read-only data sources. Or it can be used to query a specific read-only
  // data source.
  string data_source_id = 4 [(google.api.field_behavior) = REQUIRED];

  // Explain the statement.
  bool explain = 5;

  // The default schema to search objects. Equals to the current schema in
  // Oracle and search path in Postgres.
  optional string schema = 6;

  QueryOption query_option = 7;

  // Container is the container name to execute the query against, used for
  // CosmosDB only.
  optional string container = 8;
}

message QueryResponse {
  // The query results.
  repeated QueryResult results = 1;
}

message QueryOption {
  enum RedisRunCommandsOn {
    // UNSPECIFIED defaults to SINGLE_NODE.
    REDIS_RUN_COMMANDS_ON_UNSPECIFIED = 0;
    // Execute Redis commands on a single node in the cluster.
    SINGLE_NODE = 1;
    // Execute Redis commands on all nodes in the cluster for cluster-wide operations.
    ALL_NODES = 2;
  }
  RedisRunCommandsOn redis_run_commands_on = 1;

  enum MSSQLExplainFormat {
    // defaults to SHOWPLAN_ALL
    MSSQL_EXPLAIN_FORMAT_UNSPECIFIED = 0;
    // SHOWPLAN_ALL
    MSSQL_EXPLAIN_FORMAT_ALL = 1;
    // SHOWPLAN_XML
    MSSQL_EXPLAIN_FORMAT_XML = 2;
  }
  MSSQLExplainFormat mssql_explain_format = 2;
}

message QueryResult {
  // Column names of the query result.
  repeated string column_names = 1;

  // Column types of the query result.
  // The types come from the Golang SQL driver.
  repeated string column_type_names = 2;

  // Rows of the query result.
  repeated QueryRow rows = 3;

  int64 rows_count = 4;

  // The error message if the query failed.
  string error = 5;

  // The time it takes to execute the query.
  google.protobuf.Duration latency = 6;

  // The query statement for the result.
  string statement = 7;

  oneof detailed_error {
    PostgresError postgres_error = 8;
    SyntaxError syntax_error = 9;
    PermissionDenied permission_denied = 10;
  }

  // refer https://www.postgresql.org/docs/11/protocol-error-fields.html
  // for field description.
  message PostgresError {
    string severity = 1;
    string code = 2;
    string message = 3;
    string detail = 4;
    string hint = 5;
    int32 position = 6;
    int32 internal_position = 7;
    string internal_query = 8;
    string where = 9;
    string schema_name = 10;
    string table_name = 11;
    string column_name = 12;
    string data_type_name = 13;
    string constraint_name = 14;
    string file = 15;
    int32 line = 16;
    string routine = 17;
  }

  // Syntax error with position information for editor highlighting
  message SyntaxError {
    // Position information for highlighting in editor
    Position start_position = 1;
  }

  // Permission denied with resource information or disallowed command_type.
  // Either resources or command_type is available.
  message PermissionDenied {
    // Denied to access the resources.
    // Format:
    // instances/{instance}/databases/{database}
    // instances/{instance}/databases/{database}/schemas/{schema}
    // instances/{instance}/databases/{database}/tables/{table}
    // instances/{instance}/databases/{database}/schemas/{schema}/tables/{table}
    repeated string resources = 1;

    // Disallowed command_type.
    CommandType command_type = 2;

    enum CommandType {
      COMMAND_TYPE_UNSPECIFIED = 0;
      DDL = 1;
      DML = 2;
      NON_READ_ONLY = 3;
    }
  }

  message Message {
    enum Level {
      // Unspecified message level.
      LEVEL_UNSPECIFIED = 0;
      // Informational message.
      INFO = 1;
      // Warning message indicating potential issues.
      WARNING = 2;
      // Debug message for development and troubleshooting.
      DEBUG = 3;
      // General log message.
      LOG = 4;
      // Notice message for important information.
      NOTICE = 5;
      // Exception message indicating error conditions.
      EXCEPTION = 6;
    }

    Level level = 1;
    string content = 2;
  }

  // Informational or debug messages returned by the database engine during query execution.
  // Examples include PostgreSQL's RAISE NOTICE, MSSQL's PRINT, or Oracle's DBMS_OUTPUT.PUT_LINE.
  repeated Message messages = 11;

  // Masking reasons for each column (empty for non-masked columns).
  repeated MaskingReason masked = 12;
}

message MaskingReason {
  // The semantic type that triggered masking (e.g., "SSN", "email", "phone").
  string semantic_type_id = 1;

  // Human-readable semantic type title.
  string semantic_type_title = 2;

  // The masking rule ID that matched (if applicable).
  string masking_rule_id = 3;

  // The masking algorithm used.
  string algorithm = 4;

  // Additional context (e.g., "Matched global rule: PII Protection").
  string context = 5;

  // Whether masking was due to classification level.
  string classification_level = 6;

  // Icon associated with the semantic type (if any).
  string semantic_type_icon = 7;
}

message QueryRow {
  // Row values of the query result.
  repeated RowValue values = 1;
}

message RowValue {
  message Timestamp {
    google.protobuf.Timestamp google_timestamp = 1;
    // The accuracy is the number of digits after the decimal point.
    int32 accuracy = 2;
  }

  message TimestampTZ {
    google.protobuf.Timestamp google_timestamp = 1;
    // Zone is the time zone abbreviations in timezone database such as "PDT",
    // "PST". https://en.wikipedia.org/wiki/List_of_tz_database_time_zones We
    // retrieve the time zone information from the timestamptz field in the
    // database. A timestamp is in UTC or epoch time, and with zone info, we can
    // convert it to a local time string. Zone and offset are returned by
    // time.Time.Zone()
    string zone = 2;
    // The offset is in seconds east of UTC
    int32 offset = 3;
    int32 accuracy = 4;
  }

  oneof kind {
    google.protobuf.NullValue null_value = 1;
    bool bool_value = 2;
    bytes bytes_value = 3;
    double double_value = 4;
    float float_value = 5;
    int32 int32_value = 6;
    int64 int64_value = 7;
    string string_value = 8;
    uint32 uint32_value = 9;
    uint64 uint64_value = 10;
    // value_value is used for Spanner and TUPLE ARRAY MAP in Clickhouse only.
    google.protobuf.Value value_value = 11;
    // timestamp_value is used for the timestamp without time zone data type,
    // meaning it only includes the timestamp without any time zone or location
    // info. Although it may be expressed as a UTC value, it should be seen as a
    // timestamp missing location context.
    Timestamp timestamp_value = 12;
    // timestamp_tz_value is used for the timestamptz data type, which
    // accurately represents the timestamp with location information.
    TimestampTZ timestamp_tz_value = 13;
  }
}

message Advice {
  // Level represents the severity level of the advice.
  enum Level {
    // Unspecified advice level.
    ADVICE_LEVEL_UNSPECIFIED = 0;
    // Success status indicating the check passed without issues.
    SUCCESS = 1;
    // Warning status indicating potential issues that should be reviewed.
    WARNING = 2;
    // Error status indicating critical issues that must be addressed.
    ERROR = 3;
  }
  // The advice level.
  Level status = 1;

  // The advice code.
  int32 code = 2;

  // The advice title.
  string title = 3;

  // The advice content.
  string content = 4;

  // The start_position is inclusive and the end_position is exclusive.
  // TODO: use range instead
  Position start_position = 5;
  Position end_position = 6;

  // RuleType indicates the source of the linting rule.
  enum RuleType {
    // Unspecified rule type.
    RULE_TYPE_UNSPECIFIED = 0;
    // Parser-based rule enforced by the built-in SQL parser.
    // These are non-configurable, mandatory checks for schema health.
    PARSER_BASED = 1;
    // AI-powered rule defined by user in natural language.
    // These are custom, flexible checks powered by AI models.
    AI_POWERED = 2;
  }
  // The type of linting rule that generated this advice.
  RuleType rule_type = 7;
}

message ExportRequest {
  // The name is the resource name to execute the export against.
  // Format: instances/{instance}/databases/{database}
  // Format: instances/{instance}
  // Format: projects/{project}/rollouts/{rollout}
  // Format: projects/{project}/rollouts/{rollout}/stages/{stage}
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "bytebase.com/Database"}
  ];

  // The SQL statement to execute.
  string statement = 2;

  // The maximum number of rows to return.
  int32 limit = 3;

  // The export format.
  ExportFormat format = 4;

  // The admin is used for workspace owner and DBA for exporting data from SQL
  // Editor Admin mode. The exported data is not masked.
  bool admin = 5;

  // The zip password provide by users.
  string password = 6;

  // The id of data source.
  // It is used for querying admin data source even if the instance has
  // read-only data sources. Or it can be used to query a specific read-only
  // data source.
  string data_source_id = 7;

  // The default schema to search objects. Equals to the current schema in
  // Oracle and search path in Postgres.
  optional string schema = 8;
}

message ExportResponse {
  // The export file content.
  bytes content = 1;
}

message DiffMetadataRequest {
  // The metadata of the source schema.
  DatabaseMetadata source_metadata = 1 [(google.api.field_behavior) = REQUIRED];

  // The metadata of the target schema.
  DatabaseMetadata target_metadata = 2 [(google.api.field_behavior) = REQUIRED];

  // The database engine of the schema.
  Engine engine = 3;
}

message DiffMetadataResponse {
  // The diff of the metadata.
  string diff = 1;
}

message SearchQueryHistoriesRequest {
  // The maximum number of histories to return.
  // The service may return fewer than this value.
  // If unspecified, at most 10 history entries will be returned.
  // The maximum value is 1000; values above 1000 will be coerced to 1000.
  int32 page_size = 1;

  // A page token, received from a previous `ListQueryHistory` call.
  // Provide this to retrieve the subsequent page.
  string page_token = 2;

  // Filter is the filter to apply on the search query history
  // The syntax and semantics of CEL are documented at https://github.com/google/cel-spec
  //
  // Supported filter:
  // - project: the project full name in "projects/{id}" format, support "==" operator.
  // - database: the database full name in "instances/{id}/databases/{name}" format, support "==" operator.
  // - instance: the instance full name in "instances/{id}" format, support "==" operator.
  // - type: the type, should be "QUERY" or "EXPORT", support "==" operator.
  // - statement: the SQL statement, support ".matches()" operator.
  //
  // For example:
  // project == "projects/{project}"
  // database == "instances/{instance}/databases/{database}"
  // instance == "instances/{instance}"
  // type == "QUERY"
  // type == "EXPORT"
  // statement.matches("select")
  // type == "QUERY" && statement.matches("select")
  string filter = 3;
}

message SearchQueryHistoriesResponse {
  // The list of history.
  repeated QueryHistory query_histories = 1 [(google.api.field_behavior) = OUTPUT_ONLY];

  // A token to retrieve next page of history.
  // Pass this value in the page_token field in the subsequent call to
  // `ListQueryHistory` method to retrieve the next page of history.
  string next_page_token = 2;
}

message QueryHistory {
  // The name for the query history.
  // Format: queryHistories/{uid}
  string name = 1 [(google.api.field_behavior) = OUTPUT_ONLY];

  // The database name to execute the query.
  // Format: instances/{instance}/databases/{databaseName}
  string database = 2 [(google.api.field_behavior) = OUTPUT_ONLY];

  string creator = 3 [(google.api.field_behavior) = OUTPUT_ONLY];

  google.protobuf.Timestamp create_time = 4 [(google.api.field_behavior) = OUTPUT_ONLY];

  string statement = 5 [(google.api.field_behavior) = OUTPUT_ONLY];

  optional string error = 6 [(google.api.field_behavior) = OUTPUT_ONLY];

  google.protobuf.Duration duration = 7 [(google.api.field_behavior) = OUTPUT_ONLY];

  enum Type {
    // Unspecified query history type.
    TYPE_UNSPECIFIED = 0;
    // Query execution for data retrieval.
    QUERY = 1;
    // Data export operation to file.
    EXPORT = 2;
  }

  Type type = 8;
}

message AICompletionRequest {
  message Message {
    string role = 1;
    string content = 2;
  }
  repeated Message messages = 1;
}

message AICompletionResponse {
  message Candidate {
    message Content {
      message Part {
        string text = 1;
      }
      // parts is used for a result content with multiple parts.
      repeated Part parts = 1;
    }
    Content content = 1;
  }
  // candidates is used for results with multiple choices and candidates. Used
  // for OpenAI and Gemini.
  repeated Candidate candidates = 1;
}

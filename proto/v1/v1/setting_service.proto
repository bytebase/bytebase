syntax = "proto3";

package bytebase.v1;

import "google/api/annotations.proto";
import "google/api/client.proto";
import "google/api/field_behavior.proto";
import "google/api/resource.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/field_mask.proto";
import "google/type/expr.proto";
import "v1/annotation.proto";
import "v1/common.proto";
import "v1/issue_service.proto";

option go_package = "github.com/bytebase/bytebase/backend/generated-go/v1";

// SettingService manages workspace-level settings and configurations.
service SettingService {
  // Lists all workspace settings.
  // Permissions required: bb.settings.list
  rpc ListSettings(ListSettingsRequest) returns (ListSettingsResponse) {
    option (google.api.http) = {get: "/v1/settings"};
    option (google.api.method_signature) = "";
    option (bytebase.v1.permission) = "bb.settings.list";
    option (bytebase.v1.auth_method) = IAM;
  }

  // Retrieves a workspace setting by name.
  // Permissions required: bb.settings.get
  rpc GetSetting(GetSettingRequest) returns (Setting) {
    option (google.api.http) = {get: "/v1/{name=settings/*}"};
    option (google.api.method_signature) = "name";
    option (bytebase.v1.permission) = "bb.settings.get";
    option (bytebase.v1.auth_method) = IAM;
  }

  // Updates a workspace setting.
  // Permissions required: bb.settings.set
  rpc UpdateSetting(UpdateSettingRequest) returns (Setting) {
    option (google.api.http) = {
      patch: "/v1/{setting.name=settings/*}"
      body: "setting"
    };
    option (bytebase.v1.permission) = "bb.settings.set";
    option (bytebase.v1.auth_method) = IAM;
    option (bytebase.v1.audit) = true;
  }
}

message ListSettingsRequest {}

message ListSettingsResponse {
  // The settings from the specified request.
  repeated Setting settings = 1;
}

// The request message for getting a setting.
message GetSettingRequest {
  // The resource name of the setting.
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "bytebase.com/Setting"}
  ];
}

// The response message for getting a setting.
message GetSettingResponse {
  Setting setting = 1;
}

// The request message for updating or creating a setting.
message UpdateSettingRequest {
  // The setting to update.
  Setting setting = 1 [(google.api.field_behavior) = REQUIRED];

  // validate_only is a flag to indicate whether to validate the setting value,
  // server would not persist the setting value if it is true.
  bool validate_only = 2;

  bool allow_missing = 3;

  google.protobuf.FieldMask update_mask = 4;
}

// The schema of setting.
message Setting {
  option (google.api.resource) = {
    type: "bytebase.com/Setting"
    pattern: "settings/{setting}"
  };

  enum SettingName {
    SETTING_NAME_UNSPECIFIED = 0;
    WORKSPACE_PROFILE = 1;
    WORKSPACE_APPROVAL = 2;
    APP_IM = 3;
    AI = 4;
    DATA_CLASSIFICATION = 5;
    SEMANTIC_TYPES = 6;
    ENVIRONMENT = 7;
  }

  // The resource name of the setting.
  // Format: settings/{setting}
  // Example: "settings/SEMANTIC_TYPES"
  string name = 1 [(google.api.field_behavior) = IDENTIFIER];

  // The configuration value of the setting.
  SettingValue value = 2 [(google.api.field_behavior) = REQUIRED];
}

// The data in setting value.
message SettingValue {
  oneof value {
    AppIMSetting app_im = 1;
    WorkspaceProfileSetting workspace_profile = 2;
    WorkspaceApprovalSetting workspace_approval = 3;
    DataClassificationSetting data_classification = 4;
    SemanticTypeSetting semantic_type = 5;
    AISetting ai = 6;
    EnvironmentSetting environment = 7;
  }
}

message AppIMSetting {
  message Slack {
    string token = 1 [(google.api.field_behavior) = INPUT_ONLY];
  }
  message Feishu {
    string app_id = 1 [(google.api.field_behavior) = INPUT_ONLY];
    string app_secret = 2 [(google.api.field_behavior) = INPUT_ONLY];
  }
  message Wecom {
    string corp_id = 1 [(google.api.field_behavior) = INPUT_ONLY];
    string agent_id = 2 [(google.api.field_behavior) = INPUT_ONLY];
    string secret = 3 [(google.api.field_behavior) = INPUT_ONLY];
  }
  message Lark {
    string app_id = 1 [(google.api.field_behavior) = INPUT_ONLY];
    string app_secret = 2 [(google.api.field_behavior) = INPUT_ONLY];
  }
  message DingTalk {
    string client_id = 1 [(google.api.field_behavior) = INPUT_ONLY];
    string client_secret = 2 [(google.api.field_behavior) = INPUT_ONLY];
    string robot_code = 3 [(google.api.field_behavior) = INPUT_ONLY];
  }
  message Teams {
    // Azure AD tenant ID (Directory ID).
    string tenant_id = 1 [(google.api.field_behavior) = INPUT_ONLY];
    // Azure AD application (client) ID.
    string client_id = 2 [(google.api.field_behavior) = INPUT_ONLY];
    // Azure AD client secret.
    string client_secret = 3 [(google.api.field_behavior) = INPUT_ONLY];
  }

  message IMSetting {
    WebhookType type = 1;
    oneof payload {
      Slack slack = 2;
      Feishu feishu = 3;
      Wecom wecom = 4;
      Lark lark = 5;
      DingTalk dingtalk = 6;
      Teams teams = 7;
    }
  }

  repeated IMSetting settings = 1;
}

message WorkspaceProfileSetting {
  // The external URL is used for sso authentication callback.
  string external_url = 1;

  // Disallow self-service signup, users can only be invited by the owner.
  bool disallow_signup = 2;

  // Require 2FA for all users.
  bool require_2fa = 3;

  // The duration for refresh token. Default is 7 days.
  google.protobuf.Duration refresh_token_duration = 4;

  // The duration for access token. Default is 1 hour.
  google.protobuf.Duration access_token_duration = 18;

  // The setting of custom announcement
  Announcement announcement = 5;

  // The max duration for role expired.
  google.protobuf.Duration maximum_role_expiration = 6;

  // The workspace domain, e.g., bytebase.com.
  repeated string domains = 7;

  // Only user and group from the domains can be created and login.
  bool enforce_identity_domain = 8;

  // The workspace database change mode.
  DatabaseChangeMode database_change_mode = 9;

  // Whether to disallow password signin. (Except workspace admins)
  bool disallow_password_signin = 10;

  // Whether to enable metric collection for the workspace.
  bool enable_metric_collection = 11;

  // The session expiration time if not activity detected for the user. Value <= 0 means no limit.
  google.protobuf.Duration inactive_session_timeout = 12;

  // Whether to enable audit logging to stdout in structured JSON format.
  // Requires TEAM or ENTERPRISE license.
  bool enable_audit_log_stdout = 13;

  // Whether to display watermark on pages.
  // Requires ENTERPRISE license.
  bool watermark = 14;

  // The token for directory sync authentication.
  string directory_sync_token = 15;

  // The branding logo as a data URI (e.g. data:image/png;base64,...).
  string branding_logo = 16;

  message PasswordRestriction {
    // min_length is the minimum length for password, should no less than 8.
    int32 min_length = 1;
    // require_number requires the password must contains at least one number.
    bool require_number = 2;
    // require_letter requires the password must contains at least one letter, regardless of upper case or lower case
    bool require_letter = 3;
    // require_uppercase_letter requires the password must contains at least one upper case letter.
    bool require_uppercase_letter = 4;
    // require_special_character requires the password must contains at least one special character.
    bool require_special_character = 5;
    // require_reset_password_for_first_login requires users to reset their password after the 1st login.
    bool require_reset_password_for_first_login = 6;
    // password_rotation requires users to reset their password after the duration.
    google.protobuf.Duration password_rotation = 7;
  }

  // Password restriction settings.
  PasswordRestriction password_restriction = 17;
}

message Announcement {
  // We support three levels of AlertLevel: INFO, WARNING, and ERROR.
  enum AlertLevel {
    ALERT_LEVEL_UNSPECIFIED = 0;
    INFO = 1;
    WARNING = 2;
    CRITICAL = 3;
  }

  // The alert level of announcement
  AlertLevel level = 1;

  // The text of announcement
  string text = 2;

  // The optional link, user can follow the link to check extra details
  string link = 3;
}

message WorkspaceApprovalSetting {
  message Rule {
    ApprovalTemplate template = 1;
    // The condition that is associated with the rule.
    // The syntax and semantics of CEL are documented at https://github.com/google/cel-spec
    //
    // The `source` field filters which rules apply. The `condition` field then evaluates with full context.
    //
    // All supported variables:
    // statement.affected_rows: affected row count in the DDL/DML, support "==", "!=", "<", "<=", ">", ">=" operations.
    // statement.table_rows: table row count number, support "==", "!=", "<", "<=", ">", ">=" operations.
    // resource.environment_id: the environment resource id, support "==", "!=", "in [xx]", "!(in [xx])" operations.
    // resource.project_id: the project resource id, support "==", "!=", "in [xx]", "!(in [xx])", "contains()", "matches()", "startsWith()", "endsWith()" operations.
    // resource.db_engine: the database engine type, support "==", "!=", "in [xx]", "!(in [xx])" operations. Check the Engine enum for values.
    // statement.sql_type: the SQL type, support "==", "!=", "in [xx]", "!(in [xx])" operations.
    // resource.database_name: the database name, support "==", "!=", "in [xx]", "!(in [xx])", "contains()", "matches()", "startsWith()", "endsWith()" operations.
    // resource.schema_name: the schema name, support "==", "!=", "in [xx]", "!(in [xx])", "contains()", "matches()", "startsWith()", "endsWith()" operations.
    // resource.table_name: the table name, support "==", "!=", "in [xx]", "!(in [xx])", "contains()", "matches()", "startsWith()", "endsWith()" operations.
    // statement.text: the SQL statement, support "contains()", "matches()", "startsWith()", "endsWith()" operations.
    // request.expiration_days: the role expiration days for the request, support "==", "!=", "<", "<=", ">", ">=" operations.
    // request.role: the request role full name, support "==", "!=", "in [xx]", "!(in [xx])", "contains()", "matches()", "startsWith()", "endsWith()" operations.
    //
    // When source is CHANGE_DATABASE, support: statement.*, resource.* (excluding request.*)
    // When source is CREATE_DATABASE, support: resource.environment_id, resource.project_id, resource.db_engine, resource.database_name
    // When source is EXPORT_DATA, support: resource.environment_id, resource.project_id, resource.db_engine, resource.database_name, resource.schema_name, resource.table_name
    // When source is REQUEST_ROLE, support: resource.project_id, request.expiration_days, request.role
    //
    // For examples:
    // resource.environment_id == "prod" && statement.affected_rows >= 100
    // resource.table_name.matches("sensitive_.*") && resource.db_engine == "MYSQL"
    google.type.Expr condition = 2;
    Source source = 3;
    enum Source {
      SOURCE_UNSPECIFIED = 0;
      CHANGE_DATABASE = 1;
      CREATE_DATABASE = 2;
      EXPORT_DATA = 3;
      REQUEST_ROLE = 4;
    }
  }
  repeated Rule rules = 1;
}

message DataClassificationSetting {
  message DataClassificationConfig {
    // id is the uuid for classification. Each project can chose one classification config.
    string id = 1;
    string title = 2;

    message Level {
      string id = 1;
      string title = 2;
      string description = 3;
    }

    // levels is user defined level list for classification.
    // The order for the level decides its priority.
    repeated Level levels = 3;

    message DataClassification {
      // id is the classification id in [0-9]+-[0-9]+-[0-9]+ format.
      string id = 1;
      string title = 2;
      string description = 3;
      optional string level_id = 4;
    }

    // classification is the id - DataClassification map.
    // The id should in [0-9]+-[0-9]+-[0-9]+ format.
    map<string, DataClassification> classification = 4;
  }

  repeated DataClassificationConfig configs = 1;
}

message SemanticTypeSetting {
  message SemanticType {
    // id is the uuid for semantic type.
    string id = 1;
    // the title of the semantic type, it should not be empty.
    string title = 2;
    // the description of the semantic type, it can be empty.
    string description = 3;

    Algorithm algorithm = 6;

    // icon is the icon for semantic type, it can be emoji or base64 encoded image.
    string icon = 7;
  }

  repeated SemanticType types = 1;
}

message Algorithm {
  message FullMask {
    // substitution is the string used to replace the original value, the
    // max length of the string is 16 bytes.
    string substitution = 1;
  }

  message RangeMask {
    message Slice {
      // start is the start character index (0-based) of the original value, should be less than end.
      // Uses character indices (not byte offsets) for display-oriented masking.
      // Example: For "你好world", character index 2 refers to 'w' (the 3rd character).
      int32 start = 1;
      // end is the end character index (exclusive) of the original value.
      // Uses character indices (not byte offsets) for display-oriented masking.
      int32 end = 2;
      // substitution is the string used to replace the OriginalValue[start:end).
      string substitution = 3;
    }
    // We store it as a repeated field to face the fact that the original value may have multiple parts should be masked.
    // But frontend can be started with a single rule easily.
    repeated Slice slices = 1;
  }

  message MD5Mask {
    // salt is the salt value to generate a different hash that with the word alone.
    string salt = 1;
  }

  message InnerOuterMask {
    int32 prefix_len = 1;
    int32 suffix_len = 2;

    enum MaskType {
      MASK_TYPE_UNSPECIFIED = 0;
      INNER = 1;
      OUTER = 2;
    }

    MaskType type = 3;

    string substitution = 4;
  }

  oneof mask {
    FullMask full_mask = 1;
    RangeMask range_mask = 2;
    MD5Mask md5_mask = 3;
    InnerOuterMask inner_outer_mask = 4;
  }
}

enum DatabaseChangeMode {
  DATABASE_CHANGE_MODE_UNSPECIFIED = 0;
  // A more advanced database change process, including custom approval workflows and other advanced features.
  // Default to this mode.
  PIPELINE = 1;
  // A simple database change process in SQL editor. Users can execute SQL directly.
  EDITOR = 2;
}

message AISetting {
  bool enabled = 1;
  enum Provider {
    PROVIDER_UNSPECIFIED = 0;
    OPEN_AI = 1;
    CLAUDE = 2;
    GEMINI = 3;
    AZURE_OPENAI = 4;
  }
  Provider provider = 2;
  string endpoint = 3;
  string api_key = 4;
  string model = 5;
  string version = 6;
}

message EnvironmentSetting {
  repeated Environment environments = 1;

  message Environment {
    // The resource name of the environment.
    // Format: environments/{environment}.
    // Output only.
    string name = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
    // The resource id of the environment.
    // This value should be 4-63 characters, and valid characters
    // are /[a-z][0-9]-/.
    string id = 2;
    // The display name of the environment.
    string title = 3;
    map<string, string> tags = 4;
    string color = 5;
  }
}

package mysql

// Framework code is generated by the generator.

import (
	"testing"

	"github.com/bytebase/bytebase/plugin/advisor"
)

func TestIndexTypeNoBlob(t *testing.T) {
	tests := []advisor.TestCase{
		// CREATE TABLE TABLE OPTION INDEX
		{
			Statement: `CREATE TABLE t(b BLOB, PRIMARY KEY(b(10)))`,
			Want: []advisor.Advice{
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`b` is blob",
					Line:    1,
				},
			},
		},
		{
			Statement: `CREATE TABLE t(b BLOB, mb MEDIUMBLOB, lb LONGBLOB, id INT, PRIMARY KEY(b(1), mb(2), lb(3), id))`,
			Want: []advisor.Advice{
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`b` is blob",
					Line:    1,
				},
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`mb` is mediumblob",
					Line:    1,
				},
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`lb` is longblob",
					Line:    1,
				},
			},
		},
		{
			Statement: `CREATE TABLE t(b BLOB, mb MEDIUMBLOB, lb LONGBLOB, id INT, UNIQUE INDEX(b(1), mb(2), lb(3), id))`,
			Want: []advisor.Advice{
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`b` is blob",
					Line:    1,
				},
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`mb` is mediumblob",
					Line:    1,
				},
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`lb` is longblob",
					Line:    1,
				},
			},
		},
		{
			Statement: `CREATE TABLE t(b BLOB, mb MEDIUMBLOB, lb LONGBLOB, id iNT, INDEX(b(1), mb(2), lb(3), id))`,
			Want: []advisor.Advice{
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`b` is blob",
					Line:    1,
				},
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`mb` is mediumblob",
					Line:    1,
				},
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`lb` is longblob",
					Line:    1,
				},
			},
		},
		{
			Statement: `CREATE TABLE t(id INT, PRIMARY KEY(id))`,
			Want: []advisor.Advice{
				{
					Status:  advisor.Success,
					Code:    advisor.Ok,
					Title:   "OK",
					Content: "",
				},
			},
		},
		// ALTER TABLE ADD COLUMN ADD CONSTRAINT
		{
			Statement: `ALTER TABLE t ADD COLUMN b BLOB, ADD COLUMN id INT, ADD PRIMARY KEY(b(1), id)`,
			Want: []advisor.Advice{
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`b` is blob",
					Line:    1,
				},
			},
		},
		{
			Statement: `ALTER TABLE t ADD COLUMN b BLOB, ADD COLUMN mb MEDIUMBLOB, ADD COLUMN lb LONGBLOB, ADD COLUMN id INT, ADD UNIQUE INDEX(b(1), mb(2), lb(3), id)`,
			Want: []advisor.Advice{
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`b` is blob",
					Line:    1,
				},
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`mb` is mediumblob",
					Line:    1,
				},
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`lb` is longblob",
					Line:    1,
				},
			},
		},
		{
			Statement: `ALTER TABLE t ADD COLUMN b BLOB, ADD COLUMN mb MEDIUMBLOB, ADD COLUMN lb LONGBLOB, ADD COLUMN id INT, ADD INDEX(b(1), mb(2), lb(3), id)`,
			Want: []advisor.Advice{
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`b` is blob",
					Line:    1,
				},
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`mb` is mediumblob",
					Line:    1,
				},
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`lb` is longblob",
					Line:    1,
				},
			},
		},
		{
			Statement: `ALTER TABLE t ADD COLUMN b BLOB, ADD COLUMN mb MEDIUMBLOB, ADD COLUMN lb LONGBLOB, ADD COLUMN id INT, ADD INDEX(id)`,
			Want: []advisor.Advice{
				{
					Status:  advisor.Success,
					Code:    advisor.Ok,
					Title:   "OK",
					Content: "",
				},
			},
		},
		// CREATE INDEX STATEMENT
		{
			Statement: `CREATE TABLE t(b blob, mb mediumblob, lb longblob, id int);
				CREATE INDEX idx_b ON t(b(5));
				CREATE INDEX idx_mb ON t(mb(5));
				CREATE INDEX idx_lb ON t(lb(5));
				CREATE INDEX idx_id ON t(id);
			`,
			Want: []advisor.Advice{
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`b` is blob",
					Line:    2,
				},
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`mb` is mediumblob",
					Line:    3,
				},
				{
					Status:  advisor.Warn,
					Code:    advisor.IndexTypeNoBlob,
					Title:   "index.type-no-blob",
					Content: "Columns in index must not be BLOB but `t`.`lb` is longblob",
					Line:    4,
				},
			},
		},
		{
			Statement: `CREATE TABLE t(b blob, mb mediumblob, lb longblob, id int);
				CREATE INDEX idx_id ON t(id);
			`,
			Want: []advisor.Advice{
				{
					Status:  advisor.Success,
					Code:    advisor.Ok,
					Title:   "OK",
					Content: "",
				},
			},
		},
	}

	advisor.RunSQLReviewRuleTests(t, tests, &IndexTypeNoBlobAdvisor{}, &advisor.SQLReviewRule{
		Type:    advisor.SchemaRuleIndexTypeNoBlob,
		Level:   advisor.SchemaRuleLevelWarning,
		Payload: "",
	}, advisor.MockMySQLDatabase)
}

<template>
  <div class="mx-auto w-full max-w-sm">
    <div>
      <img class="h-12 w-auto" src="@/assets/logo-full.svg" alt="Bytebase" />
      <h2 class="mt-6 text-3xl leading-9 font-extrabold text-main">
        {{ $t("auth.password-reset.title") }}
      </h2>
    </div>

    <NForm class="my-6">
      <UserPassword
        ref="userPasswordRef"
        v-model:password="state.password"
        v-model:password-confirm="state.passwordConfirm"
        :show-learn-more="false"
        :password-restriction="passwordRestrictionSetting"
      />
    </NForm>
    <NButton
      class="!w-full"
      type="primary"
      size="large"
      :disabled="!allowConfirm"
      @click="onConfirm"
    >
      {{ $t("common.confirm") }}
    </NButton>
  </div>
</template>

<script lang="ts" setup>
import { NButton, NForm } from "naive-ui";
import { computed, reactive, ref, onMounted } from "vue";
import { useI18n } from "vue-i18n";
import { useRouter } from "vue-router";
import UserPassword from "@/components/User/Settings/UserPassword.vue";
import {
  pushNotification,
  useSettingV1Store,
  useUserStore,
  useAuthStore,
  useCurrentUserV1,
} from "@/store";
import { UpdateUserRequest, User } from "@/types/proto/v1/auth_service";

interface LocalState {
  password: string;
  passwordConfirm: string;
}

const state = reactive<LocalState>({
  password: "",
  passwordConfirm: "",
});

const { t } = useI18n();
const me = useCurrentUserV1();
const userStore = useUserStore();
const authStore = useAuthStore();
const userPasswordRef = ref<InstanceType<typeof UserPassword>>();
const router = useRouter();
const settingV1Store = useSettingV1Store();

const passwordRestrictionSetting = computed(
  () => settingV1Store.passwordRestriction
);

onMounted(async () => {
  if (!authStore.requireResetPassword) {
    router.replace("/");
    return;
  }
  await settingV1Store.getOrFetchSettingByName(
    "bb.workspace.password-restriction"
  );
});

const allowConfirm = computed(() => {
  if (!state.password) {
    return false;
  }
  return (
    !userPasswordRef.value?.passwordHint &&
    !userPasswordRef.value?.passwordMismatch
  );
});

const onConfirm = async () => {
  const patch: User = {
    ...me.value,
    password: state.password,
  };
  await userStore.updateUser(
    UpdateUserRequest.fromPartial({
      user: patch,
      updateMask: ["password"],
    })
  );
  pushNotification({
    module: "bytebase",
    style: "SUCCESS",
    title: t("common.updated"),
  });
  authStore.setRequireResetPassword(false);
  router.replace("/");
};
</script>

<template>
  <div class="space-y-4">
    <div class="w-full flex flex-row justify-between items-center">
      <div class="textinfolabel">
        {{ $t("role.setting.description") }}
        <a
          href="https://www.bytebase.com/docs/administration/custom-roles?source=console"
          class="normal-link text-sm inline-flex flex-row items-center"
          target="_blank"
        >
          {{ $t("common.learn-more") }}
          <heroicons-outline:external-link class="w-4 h-4" />
        </a>
      </div>
      <NButton
        type="primary"
        class="capitalize"
        :disabled="!allowCreateRole"
        @click="addRole"
      >
        <FeatureBadge
          feature="bb.feature.custom-role"
          custom-class="mr-1 text-white"
        />
        {{ $t("role.setting.add") }}
      </NButton>
    </div>
    <RoleDataTable
      :role-list="filteredRoleList"
      :show-placeholder="state.ready"
      @select-role="selectRole($event, 'EDIT')"
    />

    <div
      v-if="!state.ready"
      class="relative flex flex-col h-[8rem] items-center justify-center"
    >
      <BBSpin />
    </div>

    <RolePanel
      :role="state.detail.role"
      :mode="state.detail.mode"
      @close="state.detail.role = undefined"
    />

    <FeatureModal
      feature="bb.feature.custom-role"
      :open="showFeatureModal"
      @cancel="showFeatureModal = false"
    />
  </div>
</template>

<script lang="ts" setup>
import { sortBy } from "lodash-es";
import { NButton } from "naive-ui";
import { computed, onMounted, reactive, ref } from "vue";
import { BBSpin } from "@/bbkit";
import { FeatureBadge, FeatureModal } from "@/components/FeatureGuard";
import { featureToRef, useRoleStore } from "@/store";
import { PRESET_ROLES } from "@/types";
import { Role } from "@/types/proto/v1/role_service";
import { hasWorkspacePermissionV2 } from "@/utils";
import { RoleDataTable, RolePanel } from "./components";
import { provideCustomRoleSettingContext } from "./context";

type LocalState = {
  ready: boolean;
  detail: {
    role: Role | undefined;
    mode: "ADD" | "EDIT";
  };
  filter: {
    keyword: string;
  };
};

const roleStore = useRoleStore();
const state = reactive<LocalState>({
  ready: false,
  detail: {
    role: undefined,
    mode: "ADD",
  },
  filter: {
    keyword: "",
  },
});

const hasCustomRoleFeature = featureToRef("bb.feature.custom-role");
const showFeatureModal = ref(false);

const allowCreateRole = computed(() => {
  return hasWorkspacePermissionV2("bb.roles.create");
});

const filteredRoleList = computed(() => {
  const sortedRoles = sortBy(roleStore.roleList, (role) => {
    return PRESET_ROLES.includes(role.name)
      ? PRESET_ROLES.indexOf(role.name)
      : roleStore.roleList.length;
  });
  const keyword = state.filter.keyword.trim().toLowerCase();
  if (!keyword) return sortedRoles;
  return sortedRoles.filter((role) => {
    return (
      role.name.toLowerCase().includes(keyword) ||
      role.description.toLowerCase().includes(keyword)
    );
  });
});

const addRole = () => {
  selectRole(Role.fromPartial({}), "ADD");
};

const selectRole = (role: Role | undefined, mode?: "ADD" | "EDIT") => {
  state.detail.role = role;
  if (mode) {
    state.detail.mode = mode;
  }
};

const prepare = async () => {
  try {
    await roleStore.fetchRoleList();
  } finally {
    state.ready = true;
  }
};
onMounted(prepare);

provideCustomRoleSettingContext({
  hasCustomRoleFeature,
  showFeatureModal,
});
</script>

<template>
  <NTag
    :class="[clickable && 'cursor-pointer']"
    :type="tagType"
    round
    @click="handleClick"
  >
    <template #icon>
      <template v-if="status === 'RUNNING'">
        <TaskSpinner class="h-4 w-4 text-info" />
      </template>
      <template v-else-if="status === 'SUCCESS'">
        <CheckIcon :size="16" class="text-success" />
      </template>
      <template v-else-if="status === 'WARNING'">
        <TriangleAlertIcon :size="16" />
      </template>
      <template v-else-if="status === 'ERROR'">
        <CircleAlertIcon :size="16" />
      </template>
    </template>
    <span>{{ $t("task.check-type.sql-review") }}</span>
  </NTag>

  <SQLCheckPanel
    v-if="showDetailPanel"
    :database="database"
    :advices="advices"
    @close="showDetailPanel = false"
  />
</template>

<script setup lang="ts">
import { CheckIcon, TriangleAlertIcon, CircleAlertIcon } from "lucide-vue-next";
import { NTag } from "naive-ui";
import { computed, ref } from "vue";
import { SQLCheckPanel } from "@/components/SQLCheck";
import type { Advice } from "@/types/proto/v1/sql_service";
import { Advice_Status } from "@/types/proto/v1/sql_service";
import { databaseForTask, useIssueContext } from "../../logic";
import { TaskSpinner } from "../common";

const props = defineProps<{
  advices: Advice[];
  isRunning?: boolean;
}>();

defineEmits<{
  (event: "click"): void;
}>();

const { issue, selectedTask } = useIssueContext();
const showDetailPanel = ref(false);

const database = computed(() => {
  return databaseForTask(issue.value, selectedTask.value);
});

const status = computed(() => {
  const { isRunning, advices } = props;
  if (isRunning) {
    return "RUNNING";
  }
  if (advices.some((adv) => adv.status === Advice_Status.ERROR)) {
    return "ERROR";
  }
  if (advices.some((adv) => adv.status === Advice_Status.WARNING)) {
    return "WARNING";
  }
  return "SUCCESS";
});

const clickable = computed(() => {
  return status.value === "ERROR" || status.value === "WARNING";
});

const tagType = computed(() => {
  switch (status.value) {
    case "SUCCESS":
      return "default";
    case "RUNNING":
      return "info";
    case "WARNING":
      return "warning";
    case "ERROR":
      return "error";
  }
  // Should not reach here.
  return "default";
});

const handleClick = () => {
  showDetailPanel.value = true;
};
</script>

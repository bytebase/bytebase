<template>
  <div>
    <BBTable
      :data-source="groupedStageList"
      :show-header="true"
      :custom-header="true"
      :row-clickable="false"
    >
      <template #header>
        <tr>
          <BBTableHeaderCell compact class="w-1/12 pl-3 pr-2 capitalize">
            {{ hidePrefix(label) }}
          </BBTableHeaderCell>

          <BBTableHeaderCell
            v-for="(xValue, i) in xAxisValueList"
            :key="xValue"
            :style="{ width: headerColumnWidth }"
            compact
            class="text-center py-2"
          >
            <NPopover placement="top" trigger="hover">
              <template #trigger>
                <span
                  class="px-1.5 py-1 relative rounded inline-flex items-center hover:bg-control-bg-hover cursor-pointer select-none"
                >
                  {{ xValue }}
                </span>
              </template>
              <div class="space-y-1">
                <div class="textlabel">
                  {{ $t("deployment-config.selectors") }}
                </div>
                <DeploymentStage
                  :allow-edit="false"
                  :show-header="false"
                  :deployment="deployment.schedule.deployments[i]"
                  layout="compact"
                />
              </div>
            </NPopover>
          </BBTableHeaderCell>

          <BBTableHeaderCell v-if="hasRest" compact class="text-center py-2">
            <NPopover placement="top" trigger="hover">
              <template #trigger>
                <span
                  class="px-1.5 py-1 relative rounded inline-flex items-center hover:bg-control-bg-hover cursor-pointer select-none"
                >
                  {{ $t("deployment-config.wont-be-deployed") }}
                </span>
              </template>
              <div class="flex items-center text-sm max-w-[16rem]">
                {{ $t("deployment-config.wont-be-deployed-explanation") }}
              </div>
            </NPopover>
          </BBTableHeaderCell>
        </tr>
      </template>

      <template #body="{ rowData: matrix }">
        <BBTableCell
          :left-padding="4"
          class="pr-2 whitespace-nowrap"
          :class="{
            'text-control-placeholder': !matrix.labelValue,
          }"
        >
          <template v-if="matrix.labelValue">{{ matrix.labelValue }}</template>
          <template v-else>{{ $t("label.empty-label-value") }}</template>
        </BBTableCell>
        <BBTableCell v-for="(dbList, i) in matrix.stages" :key="i">
          <div class="flex flex-col items-center space-y-1">
            <DatabaseMatrixItem
              v-for="db in dbList"
              :key="db.id"
              :database="db"
              :label-list="labelList"
            />
            <span v-if="dbList.length === 0">-</span>
          </div>
        </BBTableCell>

        <BBTableCell v-if="hasRest">
          <div class="flex flex-col items-center space-y-1">
            <DatabaseMatrixItem
              v-for="db in matrix.rest"
              :key="db.id"
              :database="db"
              :label-list="labelList"
            />
            <span v-if="matrix.rest.length === 0">-</span>
          </div>
        </BBTableCell>
      </template>
    </BBTable>
  </div>
</template>

<script lang="ts" setup>
import { groupBy } from "lodash-es";
import { computed, withDefaults } from "vue";
import type {
  Database,
  DeploymentConfig,
  Environment,
  Label,
  LabelKeyType,
} from "../../types";
import {
  hidePrefix,
  getLabelValue,
  getPipelineFromDeploymentSchedule,
} from "../../utils";
import { NPopover } from "naive-ui";
import { DeploymentStage } from "../DeploymentConfigTool";

const props = withDefaults(
  defineProps<{
    databaseList: Database[];
    label: LabelKeyType;
    labelList: Label[];
    environmentList: Environment[];
    deployment: DeploymentConfig;
    bordered?: boolean;
    showRest?: boolean;
  }>(),
  {
    bordered: true,
    showRest: true,
  }
);

const yAxisValueList = computed(() => {
  // order based on label.valueList
  // plus one more "<empty value>"
  const key = props.label;
  const label = props.labelList.find((label) => label.key === key);
  if (!label) return [];
  return [...label.valueList, ""];
});

const xAxisValueList = computed(() => {
  // x-axis is generated by deployment stages
  return props.deployment.schedule.deployments.map((dep) => dep.name);
});

const databaseGroupList = computed(() => {
  const key = props.label;
  const dict = groupBy(props.databaseList, (db) => getLabelValue(db, key));
  const rows = yAxisValueList.value.map((labelValue) => {
    const databaseList = dict[labelValue] || [];
    return {
      labelValue,
      databaseList,
    };
  });

  if (rows.length > 0 && rows[rows.length - 1].databaseList.length === 0) {
    // ignore "<empty value>" row if no databases
    rows.pop();
  }

  return rows;
});

const groupedStageList = computed(() => {
  return databaseGroupList.value.map(({ labelValue, databaseList }) => {
    const stages = getPipelineFromDeploymentSchedule(
      databaseList,
      props.deployment.schedule
    );
    const affectedIds = stages.flatMap((dbs) => dbs.map((db) => db.id));
    const dict = new Set(affectedIds);
    const rest = props.showRest
      ? databaseList.filter((db) => !dict.has(db.id))
      : [];

    return {
      labelValue,
      stages,
      rest,
    };
  });
});

const hasRest = computed(() => {
  return groupedStageList.value.some((group) => group.rest.length > 0);
});

const headerColumnWidth = computed(() => {
  let base = xAxisValueList.value.length;
  if (hasRest.value) base += 1;
  return `${(100 - 1 / 12) / base - 1}%`;
});
</script>

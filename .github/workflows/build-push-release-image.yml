name: Build and push release image

on:
  push:
    branches:
      - 'release/*.*.*'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-release-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      actions: write
    steps:
      - uses: actions/checkout@v6
      - name: Extract build args
        # Extract version from branch name
        # Example: branch name `release/1.0.0` sets up env.IMAGE_VERSION=1.0.0
        run: |
          echo "VERSION=${GITHUB_REF_NAME#release/}" >> $GITHUB_ENV
          echo "GIT_COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - uses: depot/setup-action@v1
      - name: Build and push
        id: bytebase_build
        uses: depot/build-push-action@v1
        with:
          context: .
          project: ${{ secrets.DEPOT_PROJECT}}
          token: ${{ secrets.DEPOT_TOKEN }}
          file: scripts/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            bytebase/bytebase:${{ env.VERSION }}
          build-args: |
            VERSION=${{ env.VERSION }}
            GIT_COMMIT=${{ env.GIT_COMMIT }}
      - name: Check if version is latest
        id: check_latest
        run: |
          # Fetch all branches to get release branches
          git fetch --all

          # Get all release branch versions
          VERSIONS=$(git branch -r | grep -o 'release/[0-9]*\.[0-9]*\.[0-9]*' | sed 's/release\///' | sort -V)

          # Get the latest version
          LATEST_VERSION=$(echo "$VERSIONS" | tail -n 1)

          echo "Current version: ${{ env.VERSION }}"
          echo "Latest version: $LATEST_VERSION"

          # Check if current version is the latest
          if [ "${{ env.VERSION }}" = "$LATEST_VERSION" ]; then
            echo "is_latest=true" >> $GITHUB_OUTPUT
            echo "✅ This is the latest version"
          else
            echo "is_latest=false" >> $GITHUB_OUTPUT
            echo "ℹ️ This is not the latest version"
          fi
      - name: Trigger docker-tag-latest workflow
        if: steps.check_latest.outputs.is_latest == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'docker-tag-latest.yml',
              ref: 'main',
              inputs: {
                version: '${{ env.VERSION }}'
              }
            });
            console.log('✅ Triggered docker-tag-latest workflow for version ${{ env.VERSION }}');
